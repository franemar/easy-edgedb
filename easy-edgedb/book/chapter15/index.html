<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Chapter 15 - Time to start vampire hunting</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../chapter1/index.html"><strong aria-hidden="true">1.</strong> Chapter 1 - Jonathan Harker travels to Transylvania</a></li><li class="chapter-item expanded "><a href="../chapter2/index.html"><strong aria-hidden="true">2.</strong> Chapter 2 - At the Hotel in Bistritz</a></li><li class="chapter-item expanded "><a href="../chapter3/index.html"><strong aria-hidden="true">3.</strong> Chapter 3 - Jonathan goes to Castle Dracula</a></li><li class="chapter-item expanded "><a href="../chapter4/index.html"><strong aria-hidden="true">4.</strong> Chapter 4 - "What a strange man this Count Dracula is."</a></li><li class="chapter-item expanded "><a href="../chapter5/index.html"><strong aria-hidden="true">5.</strong> Chapter 5 - Jonathan tries to leave the castle</a></li><li class="chapter-item expanded "><a href="../chapter6/index.html"><strong aria-hidden="true">6.</strong> Chapter 6 - Still no escape</a></li><li class="chapter-item expanded "><a href="../chapter7/index.html"><strong aria-hidden="true">7.</strong> Chapter 7 - Jonathan finally "leaves" the castle</a></li><li class="chapter-item expanded "><a href="../chapter8/index.html"><strong aria-hidden="true">8.</strong> Chapter 8 - Dracula takes the boat to England</a></li><li class="chapter-item expanded "><a href="../chapter9/index.html"><strong aria-hidden="true">9.</strong> Chapter 9 - Strange events in England</a></li><li class="chapter-item expanded "><a href="../chapter10/index.html"><strong aria-hidden="true">10.</strong> Chapter 10 - Terrible events in Whitby</a></li><li class="chapter-item expanded "><a href="../chapter11/index.html"><strong aria-hidden="true">11.</strong> Chapter 11 - What's wrong with Lucy?</a></li><li class="chapter-item expanded "><a href="../chapter12/index.html"><strong aria-hidden="true">12.</strong> Chapter 12 - From bad to worse</a></li><li class="chapter-item expanded "><a href="../chapter13/index.html"><strong aria-hidden="true">13.</strong> Chapter 13 - Farewell, Lucy. Meet the new Lucy</a></li><li class="chapter-item expanded "><a href="../chapter14/index.html"><strong aria-hidden="true">14.</strong> Chapter 14 - Jonathan Harker returns</a></li><li class="chapter-item expanded "><a href="../chapter15/index.html" class="active"><strong aria-hidden="true">15.</strong> Chapter 15 - Time to start vampire hunting</a></li><li class="chapter-item expanded "><a href="../chapter16/index.html"><strong aria-hidden="true">16.</strong> Chapter 16 - Is Renfield telling the truth?</a></li><li class="chapter-item expanded "><a href="../chapter17/index.html"><strong aria-hidden="true">17.</strong> Chapter 17 - Poor Renfield. Poor Mina.</a></li><li class="chapter-item expanded "><a href="../chapter18/index.html"><strong aria-hidden="true">18.</strong> Chapter 18 - Using Dracula's own weapon against him</a></li><li class="chapter-item expanded "><a href="../chapter19/index.html"><strong aria-hidden="true">19.</strong> Chapter 19 - Dracula escapes</a></li><li class="chapter-item expanded "><a href="../chapter20/index.html"><strong aria-hidden="true">20.</strong> Chapter 20 - The final battle</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <hr />
<h2 id="tags-expression-on-error-messages"><a class="header" href="#tags-expression-on-error-messages">tags: Expression On, Error Messages</a></h2>
<h1 id="chapter-15---the-vampire-hunt-begins"><a class="header" href="#chapter-15---the-vampire-hunt-begins">Chapter 15 - The vampire hunt begins</a></h1>
<blockquote>
<p>It's good that Jonathan is back, but he is still in shock. He doesn't know if the experience with Dracula was real or not, and thinks he might be crazy. But then Jonathan meets Van Helsing who tells him that it was all true. Now that he knows everything was true, Jonathan becomes strong and confident again.</p>
<p>Our heroes begin the search for Dracula. The others learn that the Carfax mansion across from Dr. Seward's asylum is the one that Dracula bought. So that's why Renfield was so strongly affected!</p>
<p>The heroes search the house when the sun is up and find boxes of earth in which Dracula sleeps. They destroy them all in Carfax, but there are still many left in London. If they don't destroy the other boxes, Dracula will be able to rest in them during the day and terrorize London every night when the sun goes down.</p>
</blockquote>
<h2 id="more-abstract-types"><a class="header" href="#more-abstract-types">More abstract types</a></h2>
<p>Our heroes learned something about vampires in this chapter: vampires need to sleep in coffins (boxes for dead people) with holy earth during the day. That's why Dracula brought 50 of them over by ship on the Demeter. This is important for the mechanics of our game so we should create a type for this. And if we think about it:</p>
<ul>
<li>Each place in the world either has coffins or doesn't have them,</li>
<li>A place that has coffins is a place that vampires can enter and terrorize the people,</li>
<li>If a place has coffins, we should know how many of them there are.</li>
</ul>
<p>This sounds like a good case for an abstract type. Here it is:</p>
<pre><code class="language-sdl">abstract type HasCoffins {
  required coffins: int16 {
    default := 0;
  }
}
</code></pre>
<p>Most places will not have a special vampire coffin, so the default is 0. The <code>coffins</code> property is just an <code>int16</code>, and vampires can remain close to a place if the number is 1 or greater. In the mechanics of our game we would probably give vampires an activity radius of about 100 km from a place with a coffin. That's because of the typical vampire schedule which is usually as follows:</p>
<ul>
<li>Wake up refreshed in the coffin after the sun goes down, get ready to leave by 8 pm to find people to terrorize.</li>
<li>Feel a sense of freedom because the night has just begun, and start moving away from the safety of the coffins to find victims. A vampire might use a horse-driven carriage at 25 kph, which gives a pretty wide radius.</li>
<li>Around 1 or 2 am, the vampire start to feel nervous. The sun will be up in about 5 hours. Is there enough time to get home?</li>
</ul>
<p>So the part between 8 pm and 1 am is when the vampire is free to move away, and at 25 kph we get an activity radius of about 100 km around a coffin. At that distance, even the bravest vampire will start running back towards home by 2 am.</p>
<p>If we were building a more complex game, vampire terrorism on humans would be worse in the winter, when the activity radius might increase to about 150km due to longer nights... but we won't get that detailed here.</p>
<p>With our abstract type done, we will want to have a lot of types <code>extending</code> this. First we can have <code>Place</code> extend it, and that gives it to all the other location types such as <code>City</code> and <code>OtherPlace</code>:</p>
<pre><code class="language-sdl">abstract type Place extending HasCoffins {
  required name: str {
    delegated constraint exclusive;
  };
  modern_name: str;
  important_places: array&lt;str&gt;;
}
</code></pre>
<p>Ships are also big enough to have coffins (the Demeter had 50 of them, after all) so we'll extend for <code>Ship</code> as well:</p>
<pre><code class="language-sdl">type Ship extending HasCoffins {
  name: str;
  multi sailors: Sailor;
  multi crew: Crewman;
}
</code></pre>
<p>If we want, we can now make a quick function to test whether a vampire can enter a place:</p>
<pre><code class="language-sdl">function can_enter(person_name: str, place: HasCoffins) -&gt; optional str
  using (
    with vampire := (select Person filter .name = person_name),
    has_coffins := place.coffins &gt; 0,
      select vampire.name ++ ' can enter.' 
        if has_coffins else vampire.name ++ ' cannot enter.'
    );
</code></pre>
<p>The function returns an <code>optional str</code> because it may return an empty set. You'll also notice that <code>person_name</code> in this function actually just takes a str that it uses to select a <code>Person</code>. So technically it could say something like 'Jonathan Harker cannot enter'. </p>
<p>If we can't trust the user of the function to always enter a <code>Vampire</code> or <code>MinorVampire</code> object, there are some options:</p>
<ul>
<li>Overload the function to have two signatures, one for each type of Vampire:</li>
</ul>
<pre><code class="language-sdl">function can_enter(vampire: Vampire, place: HasCoffins) -&gt; optional str
function can_enter(vampire: MinorVampire, place: HasCoffins) -&gt; optional str
</code></pre>
<ul>
<li>Create an abstract type (like <code>type AnyVampire</code>) and extend it for <code>Vampire</code> and <code>MinorVampire</code>. Then <code>can_enter</code> can have this signature: </li>
</ul>
<pre><code class="language-sdl">function can_enter(vampire: AnyVampire, place: HasCoffins) -&gt; optional str
</code></pre>
<p>Let's learn a bit more about the <code>optional</code> keyword. Without it, you need to trust the users that the input argument will be there, because a function won't be called if the input is empty. We can illustrate this point with this simple function:</p>
<pre><code class="language-sdl">function try(place: City) -&gt; str
  using (
    select 'Called!'
  );
</code></pre>
<p>If we call it with this:</p>
<pre><code class="language-edgeql">select try((select City filter .name = 'London'));`
</code></pre>
<p>Then the output is <code>Called!</code> as we expected. The function requires a City as an argument, and then ignores it and returns 'Called!' instead. </p>
<p>So far so good, but the input is not optional so what happens if we type this instead?</p>
<pre><code class="language-edgeql">select try((select City filter .name = 'Beijing'));
</code></pre>
<p>Now the output will be {} because we've never inserted any data for the city 'Beijing' in our database (nobody in Bram Stoker's Dracula ever goes to Beijing). So what if we want the function to be called in any case? We can put the keyword <code>optional</code> in front of the parameter like this:</p>
<pre><code class="language-sdl">function try(place: optional City) -&gt; str
  using (
    select 'Called!'
  );
</code></pre>
<p>In this case we are still ignoring the argument <code>place</code> (the <code>City</code> type) but making it optional lets the function select 'Called!' regardless of whether it finds an argument or not. Having a <code>City</code> type and not having a <code>City</code> type are both acceptable in this case, and the function gets called in either case.</p>
<p>{ref}<code>The documentation &lt;docs:ref_sdl_function_typequal&gt;</code> explains it like this: </p>
<pre><code>...the function is called normally when the corresponding argument is empty ...
A notable example of a function that gets called on empty input is the coalescing operator.
</code></pre>
<p>Interesting! You'll remember the coalescing operator <code>??</code> that we first saw in Chapter 11. And when we look at {eql:op}<code>its signature &lt;docs:coalesce&gt;</code>, you can see the <code>optional</code> in there:</p>
<p><code>optional anytype ?? set of anytype -&gt; set of anytype</code></p>
<p>So those are some ideas for how to set up your functions depending on how you think people might use them.</p>
<p>We're coming up to an insert, so let's migrate the schema. Here are all the schema changes from the discussion so for in this chapter:</p>
<pre><code class="language-sdl">abstract type HasCoffins {
  required coffins: int16 {
    default := 0;
  }
}

abstract type Place extending HasCoffins {
  required name: str {
    delegated constraint exclusive;
  };
  modern_name: str;
  important_places: array&lt;str&gt;;
}

type Ship extending HasCoffins {
  name: str;
  multi sailors: Sailor;
  multi crew: Crewman;
}

function can_enter(person_name: str, place: HasCoffins) -&gt; optional str
  using (
    with vampire := (select Person filter .name = person_name),
    has_coffins := place.coffins &gt; 0,
      select vampire.name ++ ' can enter.' if has_coffins else vampire.name ++ ' cannot enter.'
    );
</code></pre>
<p>Now let's give London some coffins. According to the book, our heroes destroyed 29 coffins at Carfax that night, which leaves 21 in London.</p>
<pre><code class="language-edgeql">update City filter .name = 'London'
set {
  coffins := 21
};
</code></pre>
<p>Now we can finally call up our function and see if it works:</p>
<pre><code class="language-edgeql">select can_enter('Count Dracula', (select City filter .name = 'London'));
</code></pre>
<p>We get <code>{'Count Dracula can enter.'}</code>.</p>
<p>Some other possible ideas for improvement later on for <code>can_enter()</code> are:</p>
<ul>
<li>Move the property <code>name</code> from <code>Place</code> and <code>Ship</code> over to <code>HasCoffins</code>. Then the user could just enter a string. The function would then use it to <code>select</code> the type and then display its name, giving a result like &quot;Count Dracula can enter London.&quot;</li>
<li>Require a date in the function so that we can check if the vampire is dead or not first. For example, if we entered a date after Lucy died, it would just display something like the following:</li>
</ul>
<pre><code>vampire.name ++ ' is already dead on ' ++ &lt;str&gt;.date
++ ' and cannot enter ' ++ city.name`
</code></pre>
<h2 id="more-constraints"><a class="header" href="#more-constraints">More constraints</a></h2>
<p>Let's look at some more constraints. We've seen <code>exclusive</code> and <code>max_value</code> already, but there are {ref}<code>some others &lt;docs:ref_std_constraints&gt;</code> that we can use as well.</p>
<p>There is one called <code>max_len_value</code> that makes sure that a string doesn't go over a certain length. That could be good for our <code>PC</code> type. <code>NPC</code>s won't need this constraint because their names are already decided by us the creators of the game, but <code>max_len_value()</code> is good for <code>PC</code>s to make sure that players don't choose names that are too long to display. This constraint doesn't exist on the original <code>Person</code> type, so we'll also need to add the <code>overloaded</code> keyword here. The <code>PC</code> type with the new constraint now looks like this:</p>
<pre><code class="language-sdl">type PC extending Person {
  required class: Class;
  required created_at: datetime {
    default := datetime_of_statement()
  }
  required number: PCNumber {
    default := sequence_next(introspect PCNumber);
  }
  overloaded required name: str {
    constraint max_len_value(30);
  }
}
</code></pre>
<p>And now <code>PC</code> objects like this one with names that are too long won't be able to be inserted anymore:</p>
<pre><code class="language-edgeql">insert PC {
 class := Class.Rogue,
 name := &quot;Oh man, let me tell you about this PC and his name. It all began one day when..&quot;
};
</code></pre>
<p>The error is pretty nice and tells us everything we need to know:</p>
<pre><code>edgedb error: ConstraintViolationError: name must be no longer 
than 30 characters.
  Detail: `value of property 'name' of object type 'default`::`PC'` 
  must be no longer than 30 characters.
</code></pre>
<p>Another convenient constraint is called <code>one_of</code>, and is sort of like a quick enum. One place in our schema where we could use it is <code>title: str;</code> in our <code>Person</code> type. You'll remember that we added that in case we wanted to generate names from various parts (first name, last name, title, degree...). This constraint could work to make sure that people don't just make up their own titles:</p>
<pre><code class="language-sdl">title: str {
  constraint one_of('Mr.', 'Mrs.', 'Ms.', 'Lord');
}
</code></pre>
<p>For us it's probably not worth it to add a <code>one_of</code> constraint though, as there are probably too many titles throughout the book (Count, the German <em>Herr</em>, Lady, Dr., Ph.D., etc.).</p>
<p>Another place you could imagine using a <code>one_of</code> is in the months, because the book only goes from May to October of the same year. If we had an object type generating a date then you could have this sort of constraint inside it:</p>
<pre><code class="language-sdl">month: int64 {
  constraint one_of(5, 6, 7, 8, 9, 10);
}
</code></pre>
<p>But that will depend on how the game works.</p>
<p>Now let's learn about perhaps the most interesting constraint in EdgeDB: an expression that we create ourselves!</p>
<h2 id="expression-on-the-most-flexible-constraint"><a class="header" href="#expression-on-the-most-flexible-constraint"><code>expression on</code>: the most flexible constraint</a></h2>
<p>One particularly flexible constraint is called {eql:constraint}<code> ``expression on`` &lt;docs:std::expression&gt;</code>, which lets us add any expression we want. After <code>expression on</code> you add the expression (in brackets) that must return <code>true</code> to create an object. In other words: &quot;Create this object <em>as long as</em> (insert expression here)&quot;.</p>
<p>Let's say we need a type <code>Lord</code> for some reason later on, and all <code>Lord</code> types must have the word 'Lord' in their name. We can constrain the type to make sure that this is always the case. For this, we will use a function called {eql:func}<code>docs:std::contains</code> that looks like this:</p>
<pre><code class="language-sdl">std::contains(haystack: str, needle: str) -&gt; bool
</code></pre>
<p>This function returns <code>{true}</code> if the <code>haystack</code> (a string) contains the <code>needle</code> (usually a shorter string).</p>
<p>We can write the constraint with <code>expression on</code> and <code>contains()</code> like this:</p>
<pre><code class="language-sdl">type Lord extending Person {
  constraint expression on (
    contains(__subject__.name, 'Lord')
  );
}
</code></pre>
<p><code>__subject__</code> there refers to the object itself.</p>
<p>Let's do a migration here because a <code>Lord</code> type could be useful later.</p>
<p>Now when we try to insert a <code>Lord</code> without it, it won't work:</p>
<pre><code class="language-edgeql">insert Lord {
  name := 'Billy'
  # Other stuff..
};
</code></pre>
<p>But if the <code>name</code> is 'Lord Billy' (or 'Lord William', or 'Lord' anything), it will work.</p>
<p>While we're at it, let's practice doing a <code>select</code> and <code>insert</code> at the same time so we see the output of our <code>insert</code> right away. We'll change <code>Billy</code> to <code>Lord Billy</code> and say that Lord Billy (considering his great wealth) has visited every place in our database.</p>
<pre><code class="language-edgeql">select (
  insert Lord {
    name := 'Lord Billy',
    places_visited := (select Place),
  }
) {
  name,
  places_visited: {
    name
  }
};
</code></pre>
<p>Now that <code>.name</code> contains the substring <code>Lord</code>, it works like a charm:</p>
<pre><code>{
  default::Lord {
    name: 'Lord Billy',
    places_visited: {
      default::Country {name: 'Hungary'},
      default::Country {name: 'Romania'},
      default::Country {name: 'France'},
      default::Country {name: 'Slovakia'},
      default::Castle {name: 'Castle Dracula'},
      default::City {name: 'Whitby'},
      default::City {name: 'Munich'},
      default::City {name: 'Buda-Pesth'},
      default::City {name: 'Bistritz'},
      default::City {name: 'Exeter'},
      default::City {name: 'London'},
    },
  },
}
</code></pre>
<h2 id="setting-your-own-error-messages"><a class="header" href="#setting-your-own-error-messages">Setting your own error messages</a></h2>
<p>Since <code>expression on</code> is so flexible, you can use it in almost any way you can imagine. But that flexibility also means that there is no built-in way to let the user know how any <code>expression on</code> is supposed to work when a constraint is violated. Meanwhile, the automatically generated error message we have right now is not helping the user at all. Here's the message we got when we tried to insert a <code>Lord</code> named <code>Billy</code>:</p>
<pre><code>edgedb error: ConstraintViolationError: invalid Lord
  Detail: invalid value of object type 'default::Lord'
</code></pre>
<p>So there's no way to tell that the problem is that <code>name</code> needs <code>'Lord'</code> inside it. Fortunately, all constraints allow you to set your own error message just by opening up a block with <code>{}</code> and specifying an <code>errmessage</code>, like this: <code>errmessage := &quot;All lords need 'Lord' in their name.&quot;</code></p>
<p>Let's do that with our <code>Lord</code> type now:</p>
<pre><code class="language-sdl">type Lord extending Person {
  constraint expression on (contains(__subject__.name, 'Lord')) {
    errmessage := &quot;All lords need \'Lord\' in their name&quot;;
  }
}
</code></pre>
<p>If you do a migration now and try to insert a <code>Lord</code> that is just called <code>Billy</code>, the error now tells us what to do:</p>
<pre><code>`edgedb error: ConstraintViolationError: All lords need 'Lord' in their name
  Detail: All lords need 'Lord' in their name`
</code></pre>
<p>Much better! </p>
<h2 id="putting-backlinks-into-the-schema"><a class="header" href="#putting-backlinks-into-the-schema">Putting backlinks into the schema</a></h2>
<p>Back in Chapter 6 we removed <code>master</code> link from <code>MinorVampire</code>, because <code>Vampire</code> already has the <code>multi slaves</code> link to the <code>MinorVampire</code> type. One reason was complexity, and the other was because deleting without a deletion policy becomes impossible because they both depend on each other. But now that we know how to use backlinks, we can put <code>master</code> back in <code>MinorVampire</code> if we want. Let's follow the thought process that often leads to choosing to use a backlink.</p>
<p>First, here is the <code>MinorVampire</code> type at present:</p>
<pre><code class="language-sdl">type MinorVampire extending Person {
  former_self: Person;
}
</code></pre>
<p>To add the master link again, one way to start would be with a property called <code>master_name</code> that is just a string:</p>
<pre><code class="language-sdl">type MinorVampire extending Person {
  former_self: Person;
  required master_name: str;
};
</code></pre>
<p>Then we can use it to filter out the corresponding <code>Vampire</code> and assign it to a computed link named <code>master</code> as follows:</p>
<pre><code class="language-sdl">type MinorVampire extending Person {
  former_self: Person;
  required master_name: str;
  link master := (
    with master_name := .master_name
    assert_single(select Vampire filter .name = master_name));
};
</code></pre>
<p>Note: it's a single link, so we needed to add <code>assert_single()</code>. However, it looks a bit verbose, and we have to trust ourselves to input <code>master_name</code> correctly — definitely not ideal. In this case there is a simpler and more robust way to add <code>master</code>: using a backlink. The syntax is the same as the syntax we used last chapter except that we don't need to specify that the link is to a <code>MinorVampire</code>, because we are already inside the <code>MinorVampire</code> type.</p>
<pre><code class="language-sdl">type MinorVampire extending Person {
  former_self: Person;
  single link master := assert_single(.&lt;slaves[is Vampire]);
};
</code></pre>
<p>Here we have written <code>single link</code> to ensure that the backlink is not a <code>multi link</code>, which requires <code>assert_single()</code>. This might not be needed if our game allows vampires to share <code>MinorVampire</code> objects. However, in this case we are sure that there will only be one Vampire master (Count Dracula is the only master vampire in the book) so we can declare it a <code>single link</code>.</p>
<p>And if we still want to have a shortcut for <code>master_name</code>, we can just add <code>property master_name := .master.name;</code> in the above <code>{}</code> as follows:</p>
<pre><code class="language-sdl">type MinorVampire extending Person {
  former_self: Person;
  single link master := assert_single(.&lt;slaves[is Vampire]);
  property master_name := .master.name;
};
</code></pre>
<p>Now let's do a migration and test it out. We'll make a vampire named Kain, who has two <code>MinorVampire</code> slaves named Billy and Bob.</p>
<pre><code class="language-edgeql">insert Vampire {
  name := 'Kain',
  slaves := {
    (insert MinorVampire {
      name := 'Billy',
    }),
    (insert MinorVampire {
      name := 'Bob',
    })
  }
};
</code></pre>
<p>Now if the <code>MinorVampire</code> type works as it should, we should be able to see Kain via the <code>master</code> link inside <code>MinorVampire</code> and we won't have to use a backlink. Let's check:</p>
<pre><code class="language-edgeql">select MinorVampire {
  name,
  master_name,
  master: {
    name
  }
} filter .name in {'Billy', 'Bob'};
</code></pre>
<p>And the result:</p>
<pre><code>{
  default::MinorVampire {
    name: 'Billy',
    master_name: 'Kain',
    master: default::Vampire {name: 'Kain'},
  },
  default::MinorVampire {
    name: 'Bob',
    master_name: 'Kain',
    master: default::Vampire {name: 'Kain'},
  },
}
</code></pre>
<p>Beautiful! All the information is right there.</p>
<p>We won't see Kain and his slaves anymore so let's get rid of them with a quick delete query. The <code>on source delete delete target</code> deletion policy on the <code>Vampire</code> policy makes this easy: just delete Kain.</p>
<pre><code class="language-edgeql">delete Vampire filter .name = 'Kain';
</code></pre>
<p>Of course, you don't have to depend on a deletion policy to delete objects. We could have deleted all three using this query for example:</p>
<pre><code>delete Person filter .name in {'Kain', 'Billy', 'Bob'};
</code></pre>
<p>And the advantage to this deletion is that it will return all three deleted objects and their types (and even their properties and links if we wanted to show them) instead of just a single deleted <code>Vampire</code> object with the other two deletions happening unseen to us.</p>
<pre><code>{
  default::MinorVampire {id: d01726cc-ff45-11ed-8310-7f94ffdd6f3b},
  default::MinorVampire {id: d01768da-ff45-11ed-8310-171ca2c022eb},
  default::Vampire {id: d0170a16-ff45-11ed-8310-7b730ce4d4f2},
}
</code></pre>
<p>Finally, let's add a backlink to the Party type that we created in Chapter 13. That's easy! The <code>PC</code> type links to <code>Party</code> via a link called <code>party</code> so all we have to do is turn that around.</p>
<pre><code class="language-sdl">type Party {
  name: str;
  link members := .&lt;party[is PC];
}
</code></pre>
<p>As you can see, once you understand how to write backlinks you start to wonder how you ever got anything done without them. They're one of the best reasons to use EdgeDB.</p>
<p><a href="code.html">Here is all our code so far up to Chapter 15.</a></p>
<!-- quiz-start -->
<h2 id="time-to-practice"><a class="header" href="#time-to-practice">Time to practice</a></h2>
<ol>
<li>
<p>How would you create a type called Horse with a <code>required name: str</code> that can only be 'Horse'?</p>
</li>
<li>
<p>How would you let the user know that it needs to be called 'Horse'?</p>
</li>
<li>
<p>How would you make sure that <code>name</code> for type <code>NPC</code> is always between 5 and 30 characters in length?</p>
<p>Try it first with <code>expression on</code>.</p>
</li>
<li>
<p>How would you make a function called <code>display_coffins</code> that pulls up all the <code>HasCoffins</code> objects with more than 0 coffins?</p>
</li>
<li>
<p>How would you give the <code>Place</code> type a backlink to every <code>Person</code> type that visited it?</p>
</li>
</ol>
<p><a href="answers.html">See the answers here.</a></p>
<!-- quiz-end -->
<p><strong>Up next:</strong> <em>Could Renfield be of help?</em></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../chapter14/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../chapter16/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../chapter14/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../chapter16/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
