<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Chapter 9 - Strange events in England</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../chapter1/index.html"><strong aria-hidden="true">1.</strong> Chapter 1 - Jonathan Harker travels to Transylvania</a></li><li class="chapter-item expanded "><a href="../chapter2/index.html"><strong aria-hidden="true">2.</strong> Chapter 2 - At the Hotel in Bistritz</a></li><li class="chapter-item expanded "><a href="../chapter3/index.html"><strong aria-hidden="true">3.</strong> Chapter 3 - Jonathan goes to Castle Dracula</a></li><li class="chapter-item expanded "><a href="../chapter4/index.html"><strong aria-hidden="true">4.</strong> Chapter 4 - "What a strange man this Count Dracula is."</a></li><li class="chapter-item expanded "><a href="../chapter5/index.html"><strong aria-hidden="true">5.</strong> Chapter 5 - Jonathan tries to leave the castle</a></li><li class="chapter-item expanded "><a href="../chapter6/index.html"><strong aria-hidden="true">6.</strong> Chapter 6 - Still no escape</a></li><li class="chapter-item expanded "><a href="../chapter7/index.html"><strong aria-hidden="true">7.</strong> Chapter 7 - Jonathan finally "leaves" the castle</a></li><li class="chapter-item expanded "><a href="../chapter8/index.html"><strong aria-hidden="true">8.</strong> Chapter 8 - Dracula takes the boat to England</a></li><li class="chapter-item expanded "><a href="../chapter9/index.html" class="active"><strong aria-hidden="true">9.</strong> Chapter 9 - Strange events in England</a></li><li class="chapter-item expanded "><a href="../chapter10/index.html"><strong aria-hidden="true">10.</strong> Chapter 10 - Terrible events in Whitby</a></li><li class="chapter-item expanded "><a href="../chapter11/index.html"><strong aria-hidden="true">11.</strong> Chapter 11 - What's wrong with Lucy?</a></li><li class="chapter-item expanded "><a href="../chapter12/index.html"><strong aria-hidden="true">12.</strong> Chapter 12 - From bad to worse</a></li><li class="chapter-item expanded "><a href="../chapter13/index.html"><strong aria-hidden="true">13.</strong> Chapter 13 - Farewell, Lucy. Meet the new Lucy</a></li><li class="chapter-item expanded "><a href="../chapter14/index.html"><strong aria-hidden="true">14.</strong> Chapter 14 - Jonathan Harker returns</a></li><li class="chapter-item expanded "><a href="../chapter15/index.html"><strong aria-hidden="true">15.</strong> Chapter 15 - Time to start vampire hunting</a></li><li class="chapter-item expanded "><a href="../chapter16/index.html"><strong aria-hidden="true">16.</strong> Chapter 16 - Is Renfield telling the truth?</a></li><li class="chapter-item expanded "><a href="../chapter17/index.html"><strong aria-hidden="true">17.</strong> Chapter 17 - Poor Renfield. Poor Mina.</a></li><li class="chapter-item expanded "><a href="../chapter18/index.html"><strong aria-hidden="true">18.</strong> Chapter 18 - Using Dracula's own weapon against him</a></li><li class="chapter-item expanded "><a href="../chapter19/index.html"><strong aria-hidden="true">19.</strong> Chapter 19 - Dracula escapes</a></li><li class="chapter-item expanded "><a href="../chapter20/index.html"><strong aria-hidden="true">20.</strong> Chapter 20 - The final battle</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <hr />
<h2 id="tags-defaults-overloading-for-loops"><a class="header" href="#tags-defaults-overloading-for-loops">tags: Defaults, Overloading, For Loops</a></h2>
<h1 id="chapter-9---strange-events-in-england"><a class="header" href="#chapter-9---strange-events-in-england">Chapter 9 - Strange events in England</a></h1>
<p>The episode for this chapter is a flashback to see why everybody is in the town of Whitby in the first place. Our characters are from London, after all, not a small town on the east coast of England. We'll go back in time a few weeks to when the ship carrying Dracula left Varna, when Mina and Lucy were still back home. The introduction is also split into two parts. Here's the first:</p>
<blockquote>
<p>We still don't know where Jonathan is, and the ship The Demeter is on its way to England with Dracula inside. Meanwhile, Mina Harker is in London writing letters to her friend Lucy Westenra. Lucy has three boyfriends (named Dr. John Seward, Quincey Morris, and Arthur Holmwood), and they all want to marry her....</p>
</blockquote>
<h2 id="working-with-dates-some-more"><a class="header" href="#working-with-dates-some-more">Working with dates some more</a></h2>
<p>It looks like we have some more people to insert, starting with Lucy:</p>
<pre><code class="language-edgeql">insert NPC {
  name := 'Lucy Westenra',
  places_visited := (select City filter .name = 'London')
};
</code></pre>
<p>But let's think about the ship a little more before we insert the rest. Everyone on the ship was killed by Dracula, but that doesn't mean that we want to delete them from the database. After all, the crewmembers on the ship were alive before and could have interacted with some <code>PC</code> objects during that time. The book tells us that the ship left on the 6th of July, and the last person (the captain) died on the 4th of August.</p>
<p>This is a good time to add two new properties to the <code>Person</code> type to indicate when a character is alive and present in the game. We'll call these properties <code>first_appearance</code> and <code>last_appearance</code>. The name <code>last_appearance</code> is a bit better than <code>death</code>, because for the game it doesn't matter: we just want to know when characters are there or not.</p>
<p>For these two properties we will just use <code>cal::local_date</code> for the sake of simplicity. There is also a <code>cal::local_datetime</code> type that includes the time, but we should be fine with just the date.</p>
<p>We used the <code>std::to_datetime</code> function before which took seven parameters to make a <code>DateTime</code>, and <code>cal::local_date</code> has a similar but but shorter function called {eql:func}<code>docs:cal::to_local_date</code>. It just takes three integers.</p>
<p>Here are all of its signatures (we're using the third one):</p>
<pre><code>cal::to_local_date(s: str, fmt: optional str = {}) -&gt; local_date
cal::to_local_date(dt: datetime, zone: str) -&gt; local_date
cal::to_local_date(year: int64, month: int64, day: int64) -&gt; local_date
</code></pre>
<p>In addition, <code>cal::local_date</code> has a pretty simple YYYYMMDD format so casting from a string is pretty easy too:</p>
<pre><code class="language-edgeql">select &lt;cal::local_date&gt;'1893-07-08';
</code></pre>
<p>But we decided before that the dates and datetimes in our game are being generated from a source that gives us individual numbers instead of strings, so we will continue to use that method.</p>
<p>So let's do a migration now that these <code>first_appearance</code> and <code>last_appearance</code> properties have been added.</p>
<p>Doing the inserts for the <code>Crewman</code> objects with the properties <code>first_appearance</code> and <code>last_appearance</code> would have looked something like this:</p>
<pre><code class="language-edgeql">insert Crewman {
  number := count(detached Crewman) +1,
  first_appearance := cal::to_local_date(1893, 7, 6),
  last_appearance := cal::to_local_date(1893, 7, 16),
};
</code></pre>
<p>But since we already have the <code>Crewman</code> objects in the database, we can easily use the <code>update</code> and <code>set</code> syntax on all of them if we assume they all died at the same time (or if we don't care about being super precise). The query to update them looks like this:</p>
<pre><code class="language-edgeql">update Crewman
set {
  first_appearance := cal::to_local_date(1893, 7, 6),
  last_appearance  := cal::to_local_date(1893, 7, 16)
};
</code></pre>
<p>The date type to choose will of course depend on our game. Can a <code>PC</code> actually visit the ship when it's sailing to England? Will there be missions to try to save the crew before Dracula kills them? If so, then we would need more precision and a <code>cal::local_datetime</code> would make more sense. But we're fine with these approximate dates for now.</p>
<h2 id="datetime_current-and-datetime_of_statement"><a class="header" href="#datetime_current-and-datetime_of_statement">datetime_current() and datetime_of_statement()</a></h2>
<p>Speaking of dates and datetimes, sometimes it can be useful to know the datetime right now. EdgeDB has two convenient functions for this: {eql:func}<code> ``datetime_current()`` &lt;docs:std::datetime_current&gt;</code> and {eql:func}<code> ``datetime_of_statement()`` &lt;docs:std::datetime_of_statement&gt;</code>. Let's try the first one out and see what it returns:</p>
<pre><code>db&gt; select datetime_current();
{&lt;datetime&gt;'2023-05-28T10:18:56.889701Z'}
</code></pre>
<p>This can be useful if you want a post date when you insert an object. With this you can sort objects by date, delete the most recent item if you have a duplicate, and so on.</p>
<p>Note though that <code>datetime_current()</code> will not return the exact same date as another call to <code>datetime_current()</code> inside the same statement. This is because <code>datetime_current()</code> returns the datetime at which the <em>function is called</em>, not the datetime of the statement that it's in.</p>
<p>We can easily see this by calling the function twice. The timestamp is almost the same, but not quite: one is a few microseconds after the other.</p>
<pre><code>db&gt; select (datetime_current(), datetime_current());
{
  (&lt;datetime&gt;'2023-07-16T10:55:55.498380Z', 
   &lt;datetime&gt;'2023-07-16T10:55:55.498394Z')
}
</code></pre>
<p>However, if we change the function to <code>datetime_of_statement()</code>, then the exact same datetime will be returned no matter how many times we call it:</p>
<pre><code>edgedb&gt; select (datetime_of_statement(), datetime_of_statement());
{
  (&lt;datetime&gt;'2023-07-16T10:58:03.384721Z', 
   &lt;datetime&gt;'2023-07-16T10:58:03.384721Z')
}
</code></pre>
<p>Or even simpler, a query to see if one function output equals the other.</p>
<pre><code>select (
  datetime_of_statement() = datetime_of_statement(),
  datetime_current() = datetime_current(), 
);
</code></pre>
<p>This should return <code>true</code> followed by <code>false</code> - unless EdgeDB was fast enough to call <code>datetime_current()</code> twice in the same microsecond.</p>
<p>We can put one of these functions to use in our schema too. Our game will have its <code>NPC</code> objects already in the database because they are all detailed in the book, and they will be in the database long before anybody begins playing our game. However, <code>PC</code> objects will only show up when a player decides to make a character. It could be useful to add a <code>date_created</code> property to the <code>PC</code> type so that we know when it was first made.</p>
<p>Let's imagine how it would look if we put it inside the <code>Person</code> type. This is close, but not quite:</p>
<pre><code class="language-sdl">type PC extending Person {
  required class: Class;
  property created_at := datetime_of_statement(); # this is new
}
</code></pre>
<p>Because <code>created_at</code> is a computable here, and computables are calculated when you <em>query</em> an object, this would generate the date when the query happens instead of when the object is inserted. It would effectively be a <code>datetime_of_the_query_you_just_made</code> property. So to make our <code>PC</code> objects have the date when you first inserted it, we can use <code>default</code> instead. And since we are adding a default value, we might as well make <code>created_at</code> a <code>required</code> property.</p>
<pre><code class="language-sdl">type PC extending Person {
  required class: Class;
  required created_at: datetime {
    default := datetime_of_statement()
  }
}
</code></pre>
<p>Let's do a migration and give this a try with a second PC. We'll call him Max Demian and choose a <code>class</code> but nothing else, but thanks to <code>created_at</code> having a default value we don't need to specify it ourselves. Let's <code>select</code> Max Demian right after his creation to see the date he was made.</p>
<pre><code class="language-edgeql">with new_pc := (insert PC {
   name := 'Max Demian',
   class := Class.Mystic
 }),
 select new_pc {
   name,
   created_at
 };
</code></pre>
<p>The output will depend on when you do the insert, but will look something like this:</p>
<pre><code>{default::PC {name: 'Max Demian', 
created_at: &lt;datetime&gt;'2023-05-30T01:13:28.022340Z'}}
</code></pre>
<h2 id="using-the-for-and-union-keywords"><a class="header" href="#using-the-for-and-union-keywords">Using the 'for' and 'union' keywords</a></h2>
<p>We're almost ready to insert our three new characters. They are all <code>NPC</code>s that have been to London before, so the only difference between them at the moment is their name. Wouldn't it be nice if we could use a single insert instead of three?</p>
<p>To do this, we can use a <code>for</code> loop, followed by the keyword <code>union</code>. First, here's the <code>for</code> part:</p>
<pre><code class="language-edgeql">for character_name in {'John Seward', 'Quincey Morris', 'Arthur Holmwood'}
</code></pre>
<p>In other words: take this set of three strings and do something with each one. <code>character_name</code> is the variable name we chose to call each string in this set.</p>
<p><code>union</code> comes next, because it is the keyword used to join sets together. To understand why we need to write <code>union</code> in a <code>for</code> loop, take this example without <code>union</code>:</p>
<pre><code class="language-edgeql">for character_name in {'John Seward', 'Quincey Morris', 'Arthur Holmwood'}
select character_name ++ ' is great';
</code></pre>
<p>This generates an error because we are asking EdgeDB to make three queries when we are actually trying to do one. But what we want instead is a single query result (a single set) that contains the <em>unified</em> results of selecting each name. That's what the <code>union</code> keyword is for here, as it will join the sets together for us. We will also have to surround <code>select</code> in parentheses, indicating that we are capturing the result of each <code>select</code> and joining them together. Altogether the query now looks like this:</p>
<pre><code class="language-edgeql">for character_name in {'John Seward', 'Quincey Morris', 'Arthur Holmwood'}
union (select character_name ++ ' is great');
</code></pre>
<p>With this EdgeDB will select one name at a time, concatenate <code>' is great'</code> on the end, and unify them into a single set that it returns to us as follows:</p>
<pre><code>{'John Seward is great', 'Quincey Morris is great', 'Arthur Holmwood is great'}
</code></pre>
<p>Now let's use what we learned to insert the three characters at once! This query will start with the three character names, but now each time we will insert an <code>NPC</code> with its name:</p>
<pre><code class="language-edgeql">for character_name in {'John Seward', 'Quincey Morris', 'Arthur Holmwood'}
union (
  insert NPC {
    name := character_name,
    places_visited := (select City filter .name = 'London'),
    lover := (select Person filter .name = 'Lucy Westenra'),
  }
);
</code></pre>
<p>We get three <code>uuid</code>s as a response to show that they were inserted.</p>
<p>Then we can check to make sure that it worked:</p>
<pre><code class="language-edgeql">select NPC {
  name,
  places_visited: {
    name,
  },
  lover: {
    name,
  },
} filter .name in {'John Seward', 'Quincey Morris', 'Arthur Holmwood'};
</code></pre>
<p>And as we hoped, they are all connected to Lucy now.</p>
<pre><code>{
  default::NPC {
    name: 'John Seward',
    places_visited: {default::City {name: 'London'}},
    lover: {default::NPC {name: 'Lucy Westenra'}},
  },
  default::NPC {
    name: 'Quincey Morris',
    places_visited: {default::City {name: 'London'}},
    lover: {default::NPC {name: 'Lucy Westenra'}},
  },
  default::NPC {
    name: 'Arthur Holmwood',
    places_visited: {default::City {name: 'London'}},
    lover: {default::NPC {name: 'Lucy Westenra'}},
  },
}
</code></pre>
<p>By the way, now we could also use the <code>for</code> keyword to insert our five <code>Crewman</code> objects inside one <code>insert</code> instead of doing it five times. Previously we used the <code>count()</code> function to insert their numbers, but we know that the book only ever has five crewmen so it will be easier to just use a <code>for</code> loop now. With this we can put their numbers inside a single set, and use the same <code>for</code> and <code>union</code> method to insert them. Of course, we already used <code>update</code> to change the inserts but from now on in our code their insert will look like this:</p>
<pre><code class="language-edgeql">for n in {1, 2, 3, 4, 5}
union (
  insert Crewman {
    number := n,
    first_appearance := cal::to_local_date(1893, 7, 6),
    last_appearance  := cal::to_local_date(1893, 7, 16),
  }
);
</code></pre>
<p>It's a good idea to familiarize yourself with {ref}<code>the order to follow &lt;docs:ref_eql_statements_for&gt;</code> when you use <code>for</code>. Here is the syntax information from the documentation on <code>for</code>:</p>
<pre><code class="language-edgeql-synopsis">[ with with-item [, ...] ]

for variable in iterator-expr

union output-expr ;
</code></pre>
<p>The important part is the <em>iterator-expr</em> which needs to be a single simple expression that gives back some kind of set. Usually, it is a just a set inside <code>{</code> and <code>}</code>. It can also be a path, such as <code>NPC.places_visited</code>, or it can be a function call, such as <code>array_unpack()</code>. More complex expressions should have parentheses around them.</p>
<h2 id="an-interesting-migration"><a class="header" href="#an-interesting-migration">An interesting migration</a></h2>
<p>Now it's time to update Lucy with three lovers. Lucy has already ruined our plans to have <code>lover</code> as just a single link. We'll rename the <code>lover</code> link to <code>multi lovers</code> to make it a multi link instead and do a migration so that she can be linked to all three of the men. This change makes sense in any case, as other <code>Person</code> types could easily have more than one lover.</p>
<p>Sometimes migration output can be a little interesting, as EdgeDB doesn't always exactly know what we are trying to do. For example, during this migration via a previous version of EdgeDB in the summer of 2023, EdgeDB first concluded that we were dropping the <code>lover</code> link, but after being told no, asked if we instead were trying to rename it. This is a good reminder to pay attention to the questions when doing a migration, because (though rare) EdgeDB will sometimes misunderstand what you are trying to do. Here is the migration output from that time:</p>
<pre><code>c:\easy-edgedb&gt;edgedb migration create
Connecting to an EdgeDB instance at localhost:10716...
did you drop link 'lover' of object type 'default::Person'? [y,n,l,c,b,s,q,?]
&gt; n
did you rename link 'lover' of object type 'default::Person' to 'lovers'? [y,n,l,c,b,s,q,?]
&gt; y
did you convert link 'lovers' of object type 'default::Person' to 'multi' cardinality? [y,n,l,c,b,s,q,?]
&gt; y
</code></pre>
<p>In a case such as this you might feel the need to make sure that EdgeDB has understood what you have asked it to do before typing <code>edgedb migrate</code>. Looking at the ddl output in the most recent <code>.edgeql</code> migration file in our <code>migrations</code> folder shows what commands were used to change the link:</p>
<pre><code class="language-edgeql">ALTER TYPE default::Person {
      ALTER LINK lover {
          RENAME TO lovers;
      };
  };
  ALTER TYPE default::Person {
      ALTER LINK lovers {
          SET MULTI;
      };
  };
</code></pre>
<p>That looks correct!</p>
<p>If, on the other hand, we had said yes to dropping <code>link 'lover'</code>, then we would have seen these commands instead:</p>
<pre><code class="language-edgeql">ALTER TYPE default::Person {
    DROP LINK lover;
};
ALTER TYPE default::Person {
    CREATE MULTI LINK lovers: default::Person;
};
</code></pre>
<p>In this case the schema migration would still have worked, but the <code>lover</code> data would now be gone. Then we would have had to update the three men again to give them Lucy back:</p>
<pre><code class="language-edgeql">update NPC filter .name in 
 {'John Seward', 'Quincey Morris', 'Arthur Holmwood'}
   set {
    lovers := (select Person filter .name = 'Lucy Westenra')
 };
</code></pre>
<p>Here is our update for her:</p>
<pre><code class="language-edgeql">update NPC filter .name = 'Lucy Westenra'
set {
  lovers := (
    select Person filter .name in
      {'John Seward', 'Quincey Morris', 'Arthur Holmwood'}
  )
};
</code></pre>
<p>Now we'll select her to make sure it worked. Let's use <code>like</code> this time for fun when doing the filter:</p>
<pre><code class="language-edgeql">  select NPC {
    name,
    lovers: {
      name
    }
  } filter .name like 'Lucy%';
</code></pre>
<p>And this does indeed return Lucy with a link to her three lovers.</p>
<pre><code>{
  default::NPC {
    name: 'Lucy Westenra',
    lovers: {
      default::NPC {name: 'John Seward'},
      default::NPC {name: 'Quincey Morris'},
      default::NPC {name: 'Arthur Holmwood'},
    },
  },
}
</code></pre>
<h2 id="an-uninteresting-migration"><a class="header" href="#an-uninteresting-migration">An uninteresting migration</a></h2>
<p>This migration was pretty interesting, but what if you are doing a really boring migration that you are sure is safe to do? You might have pasted a schema that you've used before, or could have deleted everything inside a module, or anything else that makes you wish you didn't have to reply to every question from the CLI.</p>
<p>In this case there is a solution: just add <code>--non-interactive</code> after <code>edgedb migration create</code>, and the CLI will be quiet and put your migration together â€” if it can. If there are any changes that do require your input, such as making a parameter <code>required</code>, you will instead see the following output: <code>edgedb error: Cannot apply migration without user input</code>.</p>
<p>Note that a non-interactive migration still only creates a migration script, so it won't apply the migration before you have had a chance to review the script yourself. So don't worry!</p>
<h2 id="overloading-instead-of-making-a-new-type"><a class="header" href="#overloading-instead-of-making-a-new-type">Overloading instead of making a new type</a></h2>
<p>Last chapter we learned the <code>overloaded</code> keyword, and we can use it now to improve our schema a bit. Remember the <code>HumanAge</code> scalar type we created before? Right now it looks like this:</p>
<pre><code class="language-sdl">scalar type HumanAge extending int16 {
  constraint max_value(120);
}
</code></pre>
<p>We originally made <code>HumanAge</code> for humans to use because vampires can live forever, but humans only live up to 120. But now we can simplify things. First we move the <code>age</code> property over to the <code>Person</code> type. Then (inside the <code>NPC</code> type) we use <code>overloaded</code> to add a constraint on it there:</p>
<pre><code class="language-sdl">type NPC extending Person {
  overloaded age: int16 {
    constraint max_value(120);
  }
}
</code></pre>
<p>This is convenient because we can delete <code>age</code> from <code>Vampire</code> too. We don't need to use <code>overloaded</code> here because vampires can live up to the maximum value of 32767 for <code>int16</code> which, as far as we are concerned, is forever. The <code>Vampire</code> type will now look like this:</p>
<pre><code class="language-sdl">type Vampire extending Person {
  # age: int16; **Deleted now
  multi slaves: MinorVampire;
}
</code></pre>
<p>Okay, let's do another migration and then read the rest of the introduction for this chapter. It continues to explain what Lucy is up to:</p>
<blockquote>
<p>...Lucy chooses to marry Arthur Holmwood, and says sorry to the other two. The other two men are sad, but fortunately all three men become friends with each other.</p>
<p>Dr. Seward is depressed and tries to concentrate on his work. He is a psychiatrist who works in an asylum close to a large mansion called Carfax not far outside London. Inside the asylum is a strange man named Renfield that Dr. Seward finds most interesting. Renfield is sometimes calm, sometimes completely crazy, and Dr. Seward doesn't know why he changes his mood so quickly. Also, Renfield seems to believe that he can get power from living things by eating them!! Renfield isn't exactly a vampire, but seems to act similar sometimes.</p>
</blockquote>
<p>Oops! Looks like Lucy doesn't have three lovers anymore.  We will have to remove her as a lover from the other two gentlemen. We'll just update each of them a sad empty set.</p>
<pre><code class="language-edgeql">update NPC filter .name in {'John Seward', 'Quincey Morris'}
set {
  lovers := {} # ðŸ˜¢
};
</code></pre>
<p>That makes it easy to update Lucy's <code>lovers</code> link, since we know she now only shows up inside the <code>lovers</code> for Arthur Holmwood.</p>
<pre><code class="language-edgeql">update NPC filter .name = 'Lucy Westenra'
  set {
    lovers := (
    select Person filter NPC in .lovers
)};
</code></pre>
<p>Looks like we are mostly up to date now. The only thing left is to insert the mysterious Renfield. He is easy because he has no lover to <code>filter</code> for:</p>
<pre><code class="language-edgeql">insert NPC {
  name := 'Renfield',
  first_appearance := cal::to_local_date(1893, 5, 26),
  strength := 10,
};
</code></pre>
<p>But he has some sort of relationship to Dracula, similar to the <code>MinorVampire</code> type but different. He is also quite strong (as we will see later), so we gave him a <code>strength</code> of 10. Later on we'll learn more and more about him and his relationship with Dracula.</p>
<p><a href="code.html">Here is all our code so far up to Chapter 9.</a></p>
<!-- quiz-start -->
<h2 id="time-to-practice"><a class="header" href="#time-to-practice">Time to practice</a></h2>
<ol>
<li>
<p>Why doesn't this insert work and how can it be fixed?</p>
<pre><code class="language-edgeql">for castle in
  ['Windsor Castle', 'Neuschwanstein', 'Hohenzollern Castle']
union (
  insert Castle {
    name := castle
  }
);
</code></pre>
</li>
<li>
<p>How would you do the same insert while displaying the castle's name at the same time?</p>
</li>
<li>
<p>How would you change the <code>Vampire</code> type if all vampires needed a minimum strength of 10?</p>
</li>
<li>
<p>How would you update all the <code>Person</code> types to show that they died on September 11, 1893?</p>
<p>Hint: here's the type again:</p>
<pre><code class="language-sdl">abstract type Person {
  required name: str {
    delegated constraint exclusive;
  }
  age: int16;
  strength: int16;
  multi places_visited: Place;
  multi lovers: Person;
  first_appearance: cal::local_date;
  last_appearance: cal::local_date;
}
</code></pre>
</li>
<li>
<p>All the <code>Person</code> characters that have an <code>e</code> or an <code>a</code> in their name have been brought back to life. How would you update to do this?</p>
<p>Hint: &quot;bringing back to life&quot; means that <code>last_appearance</code> should return <code>{}</code>.</p>
</li>
</ol>
<p><a href="answers.html">See the answers here.</a></p>
<!-- quiz-end -->
<p><strong>Up next:</strong> <em>Thick fog and a storm hit the city of Whitby.</em></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../chapter8/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../chapter10/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../chapter8/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../chapter10/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
