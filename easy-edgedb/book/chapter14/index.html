<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Chapter 14 - Jonathan Harker returns</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../chapter1/index.html"><strong aria-hidden="true">1.</strong> Chapter 1 - Jonathan Harker travels to Transylvania</a></li><li class="chapter-item expanded "><a href="../chapter2/index.html"><strong aria-hidden="true">2.</strong> Chapter 2 - At the Hotel in Bistritz</a></li><li class="chapter-item expanded "><a href="../chapter3/index.html"><strong aria-hidden="true">3.</strong> Chapter 3 - Jonathan goes to Castle Dracula</a></li><li class="chapter-item expanded "><a href="../chapter4/index.html"><strong aria-hidden="true">4.</strong> Chapter 4 - "What a strange man this Count Dracula is."</a></li><li class="chapter-item expanded "><a href="../chapter5/index.html"><strong aria-hidden="true">5.</strong> Chapter 5 - Jonathan tries to leave the castle</a></li><li class="chapter-item expanded "><a href="../chapter6/index.html"><strong aria-hidden="true">6.</strong> Chapter 6 - Still no escape</a></li><li class="chapter-item expanded "><a href="../chapter7/index.html"><strong aria-hidden="true">7.</strong> Chapter 7 - Jonathan finally "leaves" the castle</a></li><li class="chapter-item expanded "><a href="../chapter8/index.html"><strong aria-hidden="true">8.</strong> Chapter 8 - Dracula takes the boat to England</a></li><li class="chapter-item expanded "><a href="../chapter9/index.html"><strong aria-hidden="true">9.</strong> Chapter 9 - Strange events in England</a></li><li class="chapter-item expanded "><a href="../chapter10/index.html"><strong aria-hidden="true">10.</strong> Chapter 10 - Terrible events in Whitby</a></li><li class="chapter-item expanded "><a href="../chapter11/index.html"><strong aria-hidden="true">11.</strong> Chapter 11 - What's wrong with Lucy?</a></li><li class="chapter-item expanded "><a href="../chapter12/index.html"><strong aria-hidden="true">12.</strong> Chapter 12 - From bad to worse</a></li><li class="chapter-item expanded "><a href="../chapter13/index.html"><strong aria-hidden="true">13.</strong> Chapter 13 - Farewell, Lucy. Meet the new Lucy</a></li><li class="chapter-item expanded "><a href="../chapter14/index.html" class="active"><strong aria-hidden="true">14.</strong> Chapter 14 - Jonathan Harker returns</a></li><li class="chapter-item expanded "><a href="../chapter15/index.html"><strong aria-hidden="true">15.</strong> Chapter 15 - Time to start vampire hunting</a></li><li class="chapter-item expanded "><a href="../chapter16/index.html"><strong aria-hidden="true">16.</strong> Chapter 16 - Is Renfield telling the truth?</a></li><li class="chapter-item expanded "><a href="../chapter17/index.html"><strong aria-hidden="true">17.</strong> Chapter 17 - Poor Renfield. Poor Mina.</a></li><li class="chapter-item expanded "><a href="../chapter18/index.html"><strong aria-hidden="true">18.</strong> Chapter 18 - Using Dracula's own weapon against him</a></li><li class="chapter-item expanded "><a href="../chapter19/index.html"><strong aria-hidden="true">19.</strong> Chapter 19 - Dracula escapes</a></li><li class="chapter-item expanded "><a href="../chapter20/index.html"><strong aria-hidden="true">20.</strong> Chapter 20 - The final battle</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <hr />
<h2 id="tags-type-annotations-backlinks"><a class="header" href="#tags-type-annotations-backlinks">tags: Type Annotations, Backlinks</a></h2>
<h1 id="chapter-14---a-ray-of-hope"><a class="header" href="#chapter-14---a-ray-of-hope">Chapter 14 - A ray of hope</a></h1>
<blockquote>
<p>Finally there is some good news: Jonathan Harker is alive. It seems that he managed to escape Castle Dracula, after which he found his way to Buda-Pesth (Budapest) in August and then to a hospital. The staff at the hospital are worried about Jonathan's mental health and send Mina a letter in which they say that he had &quot;had some fearful shock and continues to talk about wolves and poison and blood, of ghosts and demons.&quot;</p>
<p>Poor Jonathan! Sitting in the hospital he begins to wonder if he has just gone insane. Was Count Dracula real? Were the vampire women real too? Or did he just imagine the whole thing? How can Mina marry a man who is slowly going insane?</p>
<p>Mina takes a train to the hospital where Jonathan is recovering, after which they take a train back to England to the city of Exeter where they get married. Mina sends Lucy a letter from Exeter about the good news...but it arrives too late and Lucy never opens it.</p>
<p>Meanwhile, Van Helsing continues to contact his associates in universities around Europe to search for information on vampires and their activities. The men visit the graveyard as planned and see vampire Lucy walking around. When Arthur sees Lucy he finally believes Van Helsing, and so do the rest of the men. They now know that vampires are real, and manage to destroy her. Arthur is sad but also happy to see that Lucy is no longer forced to be a vampire and can now die in peace.</p>
</blockquote>
<p>Looks like we have a new city called Exeter, which is easy to add:</p>
<pre><code class="language-edgeql">insert City {
  name := 'Exeter',
  population := 40000
};
</code></pre>
<p>That's the population of Exeter at the time of the book (it has 130,000 people today), and it doesn't have a <code>modern_name</code> that is different from the one in the book.</p>
<p>We can also update the city of Buda-Pesth to add the name of the hospital where Jonathan Harker was staying. In addition, one of the universities that Van Helsing contacted for information is in the same city. Let's add them both:</p>
<pre><code class="language-edgeql">update City filter .name = 'Buda-Pesth' 
  set { important_places := [
    'Hospital of St. Joseph and Ste. Mary',
    'Buda-Pesth University'
    ] 
  };
</code></pre>
<h2 id="adding-and-accessing-properties-to-links"><a class="header" href="#adding-and-accessing-properties-to-links">Adding and accessing properties to links</a></h2>
<p>One interesting thing about links is that they can hold properties too. Since a link doesn't exist without a connection between objects, properties on a link usually have something to do with the relationship between these objects as well. Or link properties may be a computed value that only makes sense when you have objects joined by a link.</p>
<p>We can add a link property to our schema too by thinking of some more vampire physics. We know that <code>Vampire</code> objects control <code>MinorVampire</code> objects, and are so powerful that <code>MinorVampire</code>s are even deleted when their controlling <code>Vampire</code> dies. We represented this in our schema by adding a deletion policy:</p>
<pre><code class="language-edgeql">type Vampire extending Person {
  multi slaves: MinorVampire {
    on source delete delete target;
  }
}
</code></pre>
<p>Now let's add a link property as well. Both <code>MinorVampire</code>s and <code>Vampire</code>s have the property <code>strength</code>, and let's now say that a <code>Vampire</code>, with enough concentration, is able to give some of its own strength to the <code>MinorVampire</code>s that it controls. We'll call this link property <code>combined_strength</code>, and define it as the combined strength of both divided by two. So if one <code>Vampire</code> has a strength of 16 and a <code>MinorVampire</code> has a strength of 10, their combined strength will be 13 (16 plus 10, then divided by 2).</p>
<p>Added to the <code>Vampire</code> type, the <code>combined_strength</code> link property looks like this:</p>
<pre><code class="language-sdl">type Vampire extending Person {
  multi slaves: MinorVampire {
    on source delete delete target;
    property combined_strength := (Vampire.strength + .strength) / 2;
  }
}
</code></pre>
<p>And then we can add another interesting property to the <code>Vampire</code> type, called <code>army_strength</code>. This property will be the combined total of all the <code>combined_strength</code> link properties between a <code>Vampire</code> and the <code>MinorVampire</code>s it controls. So this number will be the total strength of the <code>Vampire</code>'s army when it is fully concentrating on giving as much strength as possible to its <code>MinorVampires</code>.</p>
<p>Here is what the <code>Vampire</code> type looks like after these changes. Notice anything in the syntax that looks different from what we've seen so far?</p>
<pre><code class="language-sdl">type Vampire extending Person {
  multi slaves: MinorVampire {
    on source delete delete target;
    property combined_strength := (Vampire.strength + .strength) / 2;
  }
  property army_strength := sum(.slaves@combined_strength);
}
</code></pre>
<p>That's right, there is an <code>@</code> in there! EdgeDB uses <code>@</code> to represent link properties as they are structurally somewhat different from regular properties. We don't need to get into the internal details but there are two things to keep in mind about link properties: they can only be <code>single</code>, and must always be optional.</p>
<p>And with those schema changes made, we can do a query on Count Dracula to see what his army looks like. Don't forget the <code>@</code> when doing queries too!</p>
<pre><code class="language-edgeql">select Vampire {
  name,
  age,
  strength,
  slaves: {
    name,
    strength,
    @combined_strength
  },
  army_strength
};
</code></pre>
<p>The <code>strength</code> property of Dracula's vampire slaves is determined randomly so the query output will look different on your end, but it will be similar to the output below. You can see that the <code>MinorVampire</code> types that Dracula controls are significantly stronger when he concentrates to control them as directly as possible.</p>
<pre><code>{
  default::Vampire {
    name: 'Count Dracula',
    age: 800,
    strength: 20,
    slaves: {
      default::MinorVampire {name: 'Vampire Woman 1', strength: 5, @combined_strength: {12.5}},
      default::MinorVampire {name: 'Vampire Woman 2', strength: 9, @combined_strength: {14.5}},
      default::MinorVampire {name: 'Vampire Woman 3', strength: 8, @combined_strength: {14}},
      default::MinorVampire {name: 'Lucy', strength: 9, @combined_strength: {14.5}},
    },
    army_strength: 55.5,
  },
}
</code></pre>
<h2 id="adding-annotations-to-types"><a class="header" href="#adding-annotations-to-types">Adding annotations to types</a></h2>
<p>Now that we know how to do introspection queries, we can start to give <code>annotations</code> to our types. An annotation is a string inside the type definition that gives us information about it when using an <code>introspect</code> query or when we put <code>__type__</code> into a query on an object type. By default, annotations can use the titles <code>title</code> or <code>description</code>.</p>
<p>Let's imagine that in our game a <code>City</code> needs at least 50 buildings, and we want the other developers to know this. Let's use an <code>annotation description</code> for this:</p>
<pre><code class="language-sdl">type City extending Place {
  annotation description := 'A place with 50 or more buildings. Anything else is an OtherPlace';
  population: int64;
}
</code></pre>
<p>After migrating our schema, we can now do an <code>introspect</code> query on it. We know how to do this from the last chapter - just add <code>: {name}</code> everywhere to get the inner details. Ready!</p>
<pre><code class="language-edgeql">select (introspect City) {
  annotations: {name}
  name,
  properties: {name},
};
</code></pre>
<p>Uh oh, not quite. The <code>annotations</code> part of the <code>introspect</code> query just says <code>std::description</code>:</p>
<pre><code>{
  schema::ObjectType {
    annotations: {schema::Annotation {name: 'std::description'}},
    name: 'default::City',
    properties: {
      schema::Property {name: 'name'},
      schema::Property {name: 'modern_name'},
      schema::Property {name: 'important_places'},
      schema::Property {name: 'id'},
      schema::Property {name: 'population'},
    },
  },
}
</code></pre>
<p>Let's do an <code>introspect</code> query on <code>City</code> again, but this time using the splat operator on the annotations to see what is inside.</p>
<pre><code class="language-edgeql">select (introspect City) { annotations: {*}};
</code></pre>
<p>There it is!</p>
<pre><code>{
  schema::ObjectType {
    annotations: {
      schema::Annotation {
        id: 6478af55-27fe-11ee-a636-8f86ec27644b,
        name: 'std::description',
        internal: false,
        builtin: true,
        computed_fields: [],
        inheritable: false,
        @is_owned: true,
        @owned: true,
        @value: 'A place with 50 or more buildings. Anything else is an OtherPlace',
      },
    },
  },
}
</code></pre>
<p>Ah, of course: the <code>annotations: {name}</code> part returns the name of the <em>type</em>, which is <code>std::description</code>. In other words, it's a link, and the target of a link just tells us the kind of annotation that gets used. But we're looking for the value inside it. And we can see from the <code>@</code> in the output above that the value of an annotation is a link property.</p>
<p>Let's try the query one more time:</p>
<pre><code class="language-edgeql">select (introspect City) {
  annotations: {
  name,
  @value
},
  name,
  properties: {name},
};
</code></pre>
<p>And now the actual annotation shows up in the output.</p>
<pre><code>{
  schema::ObjectType {
    annotations: {
      schema::Annotation {
        name: 'std::description',
        @value: 'A place with 50 or more buildings. Anything else is an OtherPlace',
      },
    },
    name: 'default::City',
    properties: {
      schema::Property {name: 'name'},
      schema::Property {name: 'modern_name'},
      schema::Property {name: 'important_places'},
      schema::Property {name: 'id'},
      schema::Property {name: 'population'},
    },
  },
}
</code></pre>
<p>What if we want an annotation with a different name besides <code>title</code> and <code>description</code>? This is surprisingly easy, just declare a new annotation by typing <code>abstract annotation</code> inside the schema and give it a name. We want to add a <code>warning</code> for other developers to read so that's what we'll call it:</p>
<pre><code class="language-sdl">abstract annotation warning;
</code></pre>
<p>Maybe it is important to use <code>Castle</code> instead of <code>OtherPlace</code> for not just castles, but castle towns too. Thanks to the new abstract annotation, now <code>OtherPlace</code> gives that information along with the other annotation. Here are the two annotations to add to <code>OtherPlace</code>:</p>
<pre><code class="language-sdl">type OtherPlace extending Place {
  annotation description := 'A place with under 50 buildings - hamlets, small villages, etc.';
  annotation warning := 'Castles and castle towns do not count! Use the Castle type for that';
}
</code></pre>
<p>Now let's migrate the schema again and do an introspect query on just its name and annotations:</p>
<pre><code class="language-edgeql">select (introspect OtherPlace) {
  name,
  annotations: {name, @value}
};
</code></pre>
<p>And here it is:</p>
<pre><code>{
  schema::ObjectType {
    name: 'default::OtherPlace',
    annotations: {
      schema::Annotation {
        name: 'std::description',
        @value: 'A place with under 50 buildings - hamlets, small villages, etc.',
      },
      schema::Annotation {
        name: 'default::warning',
        @value: 'Castles and castle towns do not count! Use the Castle type for that',
      },
    },
  },
}
</code></pre>
<h2 id="global-scalars"><a class="header" href="#global-scalars">Global scalars</a></h2>
<p>Every game needs to be tested before it can be sold, and it's nice to have different possible modes when testing a game. Any game testers should be able to experience the game in the same way that a regular player would, but another mode with extra information would be helpful too.</p>
<p>Another global type could help here. We've had a global <code>Time</code> object in our database for some time now, which so far is our only global type. But globals can be scalar types too.</p>
<p>A global scalar isn't an object though, so changing its value is a bit different: instead, we use the <code>set</code> and <code>unset</code> keywords to work with it.</p>
<p>To try using a global scalar we can add an enum called <code>Mode</code>, and give it two values: <code>Info</code> or <code>Debug</code>. <code>Info</code> will be the default, while <code>Debug</code> will be the mode that provides extra information for the testers. After this we can make a global called <code>tester_mode</code>:</p>
<pre><code class="language-sdl">scalar type Mode extending enum&lt;Info, Debug&gt;;

required global tester_mode: Mode {
    default := Mode.Info;
  }
</code></pre>
<p>A <code>required</code> global always needs a default value, which makes sense: a global is available across the entire database and is <code>required</code> so it must be present. The only way to ensure this is to add a default value. Fortunately, the EdgeDB compiler won't let a schema migration happen if we forget this. The error message would look like this:</p>
<pre><code>error: required globals must have a default
  ┌─ c:\easy-edgedb\dbschema\default.esdl:9:3
  │
9 │   required global tester_mode: Mode;
  │   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ error

edgedb error: cannot proceed until .esdl files are fixed
</code></pre>
<p>With the migration done, let's make sure that the global value is there:</p>
<pre><code class="language-edgeql">select global tester_mode;
</code></pre>
<p>The output is simple: just <code>{Info}</code>.</p>
<p>Changing a global scalar is easy too: just use the <code>set</code> keyword.</p>
<pre><code class="language-edgeql">set global tester_mode := Mode.Debug;
</code></pre>
<p>The output here is simple too, just a message informing us that the value was successfully set:</p>
<pre><code>OK: SET GLOBAL
</code></pre>
<p>The opposite of the <code>set</code> keyword is <code>reset</code>, which resets a global to its default value. In our case the default value is <code>Mode.Info</code>, but if we hadn't specified that <code>tester_mode</code> is <code>required</code> then the default value would have been <code>{}</code>, an empty set.</p>
<p>Pretty easy! The output below shows the sort of feedback you will see in the REPL when setting and resetting a global scalar value.</p>
<pre><code>db&gt; select global tester_mode;
{Info}
db&gt; set global tester_mode := Mode.Debug;
OK: SET GLOBAL
db&gt; select global tester_mode;
{Debug}
db&gt; reset global tester_mode;
OK: RESET GLOBAL
</code></pre>
<p>And with this global value in place, we can now do queries that match on the <code>tester_mode</code> enum. Here is an example of a query that a tester using the <code>PC</code> named Emil Sinclair might use. During regular <code>Info</code> mode the query will only show the character's own info, but during <code>Debug</code> mode it will also show info on all the <code>NPC</code> objects as well. In a more complex schema we can imagine that this could be used to show a tester the health, location and so on of all the NPCs in a game, which could then be used to show them on a map or in a separate chart on the screen that is only visible during debug mode.</p>
<pre><code class="language-edgeql"># Select all NPC objects in Debug mode
with info := NPC if global tester_mode = Mode.Debug 
             else &lt;NPC&gt;{},
  select PC {
    name,
    class,
    strength,
    locations := .places_visited.name,
    npc_info := info { 
      name, 
      strength
    }
} filter .name = 'Emil Sinclair';
</code></pre>
<p>The output is pretty short during <code>Info</code> mode, which only provides the necessary info to play the game in the same way as every other player.</p>
<pre><code>{
  default::PC {
    name: 'Emil Sinclair',
    class: Mystic,
    strength: 2,
    locations: {},
    npc_info: {},
  },
}
</code></pre>
<p>But if you use <code>set global tester_mode := Mode.Debug;</code> then all of a sudden the same query will display all of the extra info!</p>
<pre><code>{
  default::PC {
    name: 'Emil Sinclair',
    class: Mystic,
    strength: 2,
    locations: {},
    npc_info: {
      default::NPC {name: 'Jonathan Harker', strength: 5},
      default::NPC {name: 'Renfield', strength: 10},
      default::NPC {name: 'The innkeeper', strength: 1},
      default::NPC {name: 'Mina Murray', strength: 2},
      default::NPC {name: 'Quincey Morris', strength: 4},
      default::NPC {name: 'Arthur Holmwood', strength: 4},
      default::NPC {name: 'John Seward', strength: 3},
      default::NPC {name: 'Abraham Van Helsing', strength: 1},
      default::NPC {name: 'Lucy Westenra', strength: 0},
    },
  },
}
</code></pre>
<p>You could imagine some other combinations of global modes such as a &quot;God Mode&quot; that also makes the character invincible - because it's annoying to try to debug test a game when other <code>PC</code>s think you are a regular player and keep killing your character without knowing that you are just there to test the game mechanics.</p>
<h2 id="backlinks"><a class="header" href="#backlinks">Backlinks</a></h2>
<p>It's finally time to learn one of EdgeDB's most powerful and useful features: backlinks. A backlink is like a regular link, except that it works in the other direction: instead of a link from your object to other objects, it's a computed property that shows the objects that link to you!</p>
<p>Understanding backlinks and the syntax can take a bit of effort, but it's well worth it.</p>
<p>First let's start by looking at some regular links. We know how to get Count Dracula's <code>slaves</code> by name with something like this:</p>
<pre><code class="language-edgeql">select Vampire {
  name,
  slaves: {
    name
  }
};
</code></pre>
<p>That shows us the following:</p>
<pre><code>{
  default::Vampire {
    name: 'Count Dracula',
    slaves: {
      default::MinorVampire {name: 'Vampire Woman 1'},
      default::MinorVampire {name: 'Vampire Woman 2'},
      default::MinorVampire {name: 'Vampire Woman 3'},
      default::MinorVampire {name: 'Lucy'},
    },
  },
}
</code></pre>
<p>But what if we are doing the opposite? Namely, starting from <code>select MinorVampire</code> and wanting to access the <code>Vampire</code> type connected to it. Because right now the <code>MinorVampire</code> type only gives us access to properties and links that belong to the <code>MinorVampire</code> and <code>Person</code> type. Imagine that we want to have a <code>master</code> link that shows the <code>Vampire</code> object that links to a <code>MinorVampire</code>...how do we do it?</p>
<pre><code class="language-edgeql">select MinorVampire {
  name,
  # master... how do we get this?
  # There's no link to Vampire inside MinorVampire...
}
</code></pre>
<p>Since there's no <code>master: Vampire</code> link, how do we go backwards to see the <code>Vampire</code> type that links to it?</p>
<p>This is where backlinks come in, by doing the following:</p>
<ul>
<li>Select the type that is being linked back to. Here that would be <code>MinorVampire</code>, because we want to see links to <code>MinorVampire</code> objects. If you are inside a type's schema, you don't need to write the type name.</li>
<li>Create a link that uses the <code>.&lt;</code> syntax instead of <code>.</code></li>
<li>Indicate the name of the link. We want to see <code>slaves</code> links from the <code>Vampire</code> type, so type <code>slaves</code> next.</li>
<li>Specify the type that we are looking for: <code>[is Vampire]</code>. This isn't strictly necessary, but helpful. We'll see why in a moment.</li>
</ul>
<p>So let's follow these steps to make our first backlink query. We want:</p>
<ul>
<li>A link to <code>MinorVampire</code> objects, so <code>select MinorVampire</code></li>
<li>The link to be a backlink, so add <code>.&lt;</code>: <code>select MinorVampire.&lt;</code></li>
<li>To look for links via a link called <code>slaves</code>, so add <code>slaves</code>: <code>select MinorVampire.&lt;slaves</code></li>
<li>The link to be from a <code>Vampire</code> object, so add <code>Vampire</code>: <code>select MinorVampire.&lt;slaves[is Vampire]</code></li>
</ul>
<p>This will return us one or more <code>Vampire</code> objects, on which of course we can add a shape. So the query will now look like this:</p>
<pre><code class="language-edgeql">select MinorVampire.&lt;slaves[is Vampire] {
  name,
  age
};
</code></pre>
<p>Because it goes in reverse order, it is selecting the <code>Vampire</code> objects that have a link called <code>slaves</code> that goes back <code>.&lt;</code> to the type <code>MinorVampire</code>.</p>
<p>You can think of the human readable version of <code>MinorVampire.&lt;slaves[is Vampire] {name, age}</code> as &quot;Show the name and age of the Vampire objects with a link called <code>slaves</code> that are of type MinorVampire&quot; - from right to left.</p>
<p>Here is the output:</p>
<pre><code>{default::Vampire {name: 'Count Dracula', age: 800}}
</code></pre>
<p>So far that's the same as just <code>select Vampire: {name, age}</code>. But it becomes very useful in our query before, where we wanted to access multiple types. Now we can select all the <code>MinorVampire</code> objects and their master:</p>
<pre><code class="language-edgeql">select MinorVampire {
  name,
  master := .&lt;slaves[is Vampire] {name},
};
</code></pre>
<p>And here is the human-readable version of <code>.&lt;slaves[is Vampire] {name}</code> to help it stick in your memory: &quot;the <code>Vampire</code> objects and their names that link back to <code>MinorVampire</code> through the link <code>slaves</code>&quot;.</p>
<p>Here is the output:</p>
<pre><code>{
  default::MinorVampire {name: 'Vampire Woman 1', 
    master: {default::Vampire {name: 'Count Dracula'}}},
  default::MinorVampire {name: 'Vampire Woman 2', 
    master: {default::Vampire {name: 'Count Dracula'}}},
  default::MinorVampire {name: 'Vampire Woman 3', 
    master: {default::Vampire {name: 'Count Dracula'}}},
  default::MinorVampire {name: 'Lucy', 
    master: {default::Vampire {name: 'Count Dracula'}}},
}
</code></pre>
<p>So why do we need <code>[is Vampire]</code> in the query anyway? We need this because there might be other objects of different types that link back to <code>MinorVampire</code> through a link called <code>slaves</code>. We can show this in a query on our <code>Place</code> type which is linked from quite a few types. What do you think this query will show?</p>
<pre><code class="language-edgeql">select Place {
 name,
 visitors := .&lt;places_visited
 };
</code></pre>
<p>In this case, we are asking EdgeDB to show us each and every object that is linking to each <code>Place</code> object via a link called <code>places_visited</code>. The output is quite large, so here is just one part of it:</p>
<pre><code>{
  default::Country {
    name: 'Romania',
    visitors: {
      default::Vampire {id: 41c0bdc4-fef1-11ed-a968-cb41382f27c2},
      default::NPC {id: e03f804e-f9b4-11ed-86c0-835ec28e5d08},
    },
  },
  default::City {
    name: 'Munich',
    visitors: {
      default::PC {id: dfd4e9dc-f9b4-11ed-86c0-b32fa282657d},
      default::NPC {id: e03f804e-f9b4-11ed-86c0-835ec28e5d08},
    },
  }
}
</code></pre>
<p>You can see that Romania has been visited by a <code>Vampire</code> object (that's Dracula) and an <code>NPC</code> object (that's Jonathan Harker), while Munich has been visited by a <code>PC</code> object (Emil Sinclair) and an <code>NPC</code> object (Jonthan Harker again).</p>
<p>So if we don't specify with <code>[is Vampire]</code> or <code>[is NPC]</code> then it will just return each and every object connected via a link called <code>places_visited</code>. This is fine, but it limits the shapes that we can make in the query. For example, there is no guarantee that any linking object will have the property <code>name</code> so this query won't work:</p>
<pre><code>db&gt; select Place {
.......  name,
.......  visitors := .&lt;places_visited {name}
.......  };
error: InvalidReferenceError: object type 'std::BaseObject' has no link or property 'name'
  ┌─ &lt;query&gt;:3:32
  │
3 │  visitors := .&lt;places_visited {name}
  │                                ^^^^ error
</code></pre>
<p>But if we specify the type, EdgeDB will now be able to tell if it has a certain property or not.</p>
<pre><code class="language-edgeql">select Place {
  name,
  vampire_visitors := .&lt;places_visited[is Vampire] {name},
  npc_visitors := .&lt;places_visited[is NPC] {name}
};
</code></pre>
<p>And with that we get a nice output that shows backlinks from multiple concrete types. Here is part of the output:</p>
<pre><code>{
  default::Country {
    name: 'Romania',
    vampire_visitors: {default::Vampire {name: 'Count Dracula'}},
    npc_visitors: {default::NPC {name: 'Jonathan Harker'}},
  },
  default::City {
    name: 'Munich',
    vampire_visitors: {},
    npc_visitors: {default::NPC {name: 'Jonathan Harker'}},
  },
}
</code></pre>
<p>One final note: this is why backlinks in EdgeDB are <code>multi</code> by default, as opposed to regular links which are <code>single</code> by default. After all, there might be a lot of objects here and there in our database that link back and it makes sense to assume that there could be a lot of them. But you can declare a backlink in your schema to be <code>single</code> if you want to insist that there can only be one object in a backlink.</p>
<p><a href="code.html">Here is all our code so far up to Chapter 14.</a></p>
<!-- quiz-start -->
<h2 id="time-to-practice"><a class="header" href="#time-to-practice">Time to practice</a></h2>
<ol>
<li>
<p>How would you create a global str that tells you whether vampires are currently asleep or awake?</p>
</li>
<li>
<p>Using a computed backlink, how would you display 1) all the <code>Place</code> objects (plus their names) that have an <code>o</code> in the name and 2) the names of the people that visited them?</p>
</li>
<li>
<p>Using a computed backlink, how would you display all the Person objects that will later become <code>MinorVampire</code>s?</p>
<p>Hint: Remember, <code>MinorVampire</code> has a link back to the vampire's former self.</p>
</li>
<li>
<p>How would you give the <code>MinorVampire</code> type an annotation called <code>note</code> that says <code>'first_appearance for MinorVampire should always match last_appearance for its matching NPC type'</code>?</p>
</li>
<li>
<p>How would you see this <code>note</code> annotation for <code>MinorVampire</code> in a query?</p>
</li>
</ol>
<p><a href="answers.html">See the answers here.</a></p>
<!-- quiz-end -->
<p><strong>Up next:</strong> <em>Time to get revenge.</em></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../chapter13/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../chapter15/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../chapter13/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../chapter15/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
