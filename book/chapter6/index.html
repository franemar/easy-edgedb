<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Chapter 6 - Still no escape</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../chapter1/index.html"><strong aria-hidden="true">1.</strong> Chapter 1 - Jonathan Harker travels to Transylvania</a></li><li class="chapter-item expanded "><a href="../chapter2/index.html"><strong aria-hidden="true">2.</strong> Chapter 2 - At the Hotel in Bistritz</a></li><li class="chapter-item expanded "><a href="../chapter3/index.html"><strong aria-hidden="true">3.</strong> Chapter 3 - Jonathan goes to Castle Dracula</a></li><li class="chapter-item expanded "><a href="../chapter4/index.html"><strong aria-hidden="true">4.</strong> Chapter 4 - "What a strange man this Count Dracula is."</a></li><li class="chapter-item expanded "><a href="../chapter5/index.html"><strong aria-hidden="true">5.</strong> Chapter 5 - Jonathan tries to leave the castle</a></li><li class="chapter-item expanded "><a href="../chapter6/index.html" class="active"><strong aria-hidden="true">6.</strong> Chapter 6 - Still no escape</a></li><li class="chapter-item expanded "><a href="../chapter7/index.html"><strong aria-hidden="true">7.</strong> Chapter 7 - Jonathan finally "leaves" the castle</a></li><li class="chapter-item expanded "><a href="../chapter8/index.html"><strong aria-hidden="true">8.</strong> Chapter 8 - Dracula takes the boat to England</a></li><li class="chapter-item expanded "><a href="../chapter9/index.html"><strong aria-hidden="true">9.</strong> Chapter 9 - Strange events in England</a></li><li class="chapter-item expanded "><a href="../chapter10/index.html"><strong aria-hidden="true">10.</strong> Chapter 10 - Terrible events in Whitby</a></li><li class="chapter-item expanded "><a href="../chapter11/index.html"><strong aria-hidden="true">11.</strong> Chapter 11 - What's wrong with Lucy?</a></li><li class="chapter-item expanded "><a href="../chapter12/index.html"><strong aria-hidden="true">12.</strong> Chapter 12 - From bad to worse</a></li><li class="chapter-item expanded "><a href="../chapter13/index.html"><strong aria-hidden="true">13.</strong> Chapter 13 - Farewell, Lucy. Meet the new Lucy</a></li><li class="chapter-item expanded "><a href="../chapter14/index.html"><strong aria-hidden="true">14.</strong> Chapter 14 - Jonathan Harker returns</a></li><li class="chapter-item expanded "><a href="../chapter15/index.html"><strong aria-hidden="true">15.</strong> Chapter 15 - Time to start vampire hunting</a></li><li class="chapter-item expanded "><a href="../chapter16/index.html"><strong aria-hidden="true">16.</strong> Chapter 16 - Is Renfield telling the truth?</a></li><li class="chapter-item expanded "><a href="../chapter17/index.html"><strong aria-hidden="true">17.</strong> Chapter 17 - Poor Renfield. Poor Mina.</a></li><li class="chapter-item expanded "><a href="../chapter18/index.html"><strong aria-hidden="true">18.</strong> Chapter 18 - Using Dracula's own weapon against him</a></li><li class="chapter-item expanded "><a href="../chapter19/index.html"><strong aria-hidden="true">19.</strong> Chapter 19 - Dracula escapes</a></li><li class="chapter-item expanded "><a href="../chapter20/index.html"><strong aria-hidden="true">20.</strong> Chapter 20 - The final battle</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <hr />
<h2 id="tags-updating-filtering-on-insert-json"><a class="header" href="#tags-updating-filtering-on-insert-json">tags: Updating, Filtering On Insert, Json</a></h2>
<h1 id="chapter-6---still-no-escape"><a class="header" href="#chapter-6---still-no-escape">Chapter 6 - Still no escape</a></h1>
<p>This chapter picks up right where the last one left off:</p>
<blockquote>
<p>The women vampires are next to Jonathan and he can't move. Suddenly, Dracula runs into the room and tells the women to leave. He yells: &quot;You can have him later, but not tonight!&quot; The women listen to him, and leave.</p>
<p>Jonathan doesn't remember anything else about that night. He wakes up in his bed the next day and it feels like a bad dream...but he sees that somebody folded his clothes, and he knows it was not just a dream.</p>
<p>The castle has some visitors from Slovakia the next day, which gives Jonathan an idea. He writes two letters, one to Mina and one to his manager at work. He gives the visitors some money, asks them to send the letters, and runs back to his room. But Dracula finds the letters and is angry. He burns the letters in front of Jonathan and tells him not to do that again. Jonathan is still stuck in the castle, and Dracula knows that Jonathan tried to trick him.</p>
</blockquote>
<h2 id="updating-and-filtering-on-sets-when-doing-an-insert"><a class="header" href="#updating-and-filtering-on-sets-when-doing-an-insert">Updating and filtering on sets when doing an insert</a></h2>
<p>There is not much new in this lesson when it comes to types, so let's work on our schema and inserts a bit. Right now Jonathan Harker is still inserted like this:</p>
<pre><code class="language-edgeql">insert NPC {
  name := 'Jonathan Harker',
  places_visited := City,
};
</code></pre>
<p>This was fine when we only had cities, but now we have the <code>Place</code> and <code>Country</code> types. First we'll insert two more <code>Country</code> types to have some more variety:</p>
<pre><code class="language-edgeql">insert Country { name := 'France' };
insert Country { name := 'Slovakia' };
</code></pre>
<p>(In Chapter 9 we'll learn how to do this with just one <code>insert</code>!)</p>
<p>Then we'll make two new types called <code>Castle</code> and <code>OtherPlace</code>. <code>Castle</code> will be used for castles and castle towns, and <code>OtherPlace</code> for any other kind of place. They are super easy to make:</p>
<pre><code class="language-sdl">type Castle extending Place;
type OtherPlace extending Place;
</code></pre>
<p>Put that into the schema and do a migration, and now we can insert our first <code>Castle</code>:</p>
<pre><code class="language-edgeql">insert Castle {
  name := 'Castle Dracula'
};
</code></pre>
<p>We will insert some <code>OtherPlace</code> objects later on in the book. Now we have a good number of types from <code>Place</code> that aren't of the <code>City</code> type.</p>
<p>Now let's get back to Jonathan. In our database, he's been to four cities, one country, and one <code>Castle</code>...but he hasn't been to Slovakia or France, so we can't just insert him with <code>places_visited := select Place</code>. Instead, we can filter on <code>Place</code> against a set with the names of the places he has visited. If we were inserting Jonathan Harker for the first time, it would look like this:</p>
<pre><code class="language-edgeql">insert NPC {
  name := 'Jonathan Harker',
  places_visited := (
    select Place filter .name in {'Munich', 'Buda-Pesth', 'Bistritz', 
    'London', 'Romania', 'Castle Dracula'}
  )
};
</code></pre>
<pre><code class="language-{eval-rst}">.. note::
  You'll notice that we just wrote the names in a set using {}, so we didn't need to use an array with [] to do it. (This is called a {ref}`set constructor &lt;docs:ref_eql_set_constructor&gt;`, by the way.)
</code></pre>
<p>But we already have a Jonathan Harker in the database. We could always do a quick <code>delete NPC filter .name = 'Jonathan Harker'</code> before doing this insert, but that's not ideal. Instead, we should do an update. For that we have the <code>update</code> and <code>set</code> keywords. The <code>update</code> keyword selects the type to start the update, and <code>set</code> is used to specify the parts that we want to change. We'll also want to use <code>filter</code> to make sure that we are only updating the <code>NPC</code> object named Jonathan Harker, and not every single <code>NPC</code> object in the database.</p>
<p>So let's update Jonathan with this code instead:</p>
<pre><code class="language-edgeql">update NPC 
filter .name = 'Jonathan Harker'
set {
  places_visited := (
    select Place filter .name in 
    {'Munich', 'Buda-Pesth', 'Bistritz', 'London', 'Romania', 'Castle Dracula'}
  )
};
</code></pre>
<p>Now what if Jonathan ever escapes Castle Dracula and runs away to a new place? Let's pretend that the <code>PC</code> named Emil Sinclair changed the flow of the story by saving Jonathan and taking him away to Slovakia. In that case, we could select the <code>Place</code> object and use <code>+=</code> to add it to Jonathan's <code>places_visited</code> property:</p>
<pre><code class="language-edgeql">update NPC
filter .name = 'Jonathan Harker'
set {
  places_visited += (select Place filter .name = 'Slovakia')
};
</code></pre>
<p>And to undo this change, you can just change <code>+=</code> to <code>-=</code> and run the command again. Let's do that, because Jonathan Harker doesn't ever actually end up visiting Slovakia.</p>
<p>EdgeDB will return the IDs of the objects that have been updated. In our case, it's just one:</p>
<pre><code>{default::NPC {id: ca4e21c8-014f-11ec-9658-7f88bf45dae6}}
</code></pre>
<p>However, this doesn't mean that <code>places_visited</code> has been changed. If we had written something like <code>filter .name = 'SLLLovakia'</code> then the <code>set</code> portion of the update would have simply added an empty <code>{}</code> set to <code>places_visited</code>, because nothing matched the filter there. The returned <code>default::NPC</code> simply means that an <code>NPC</code> object was found that matched <code>filter .name = 'Jonathan Harker</code>, and that <em>something</em> was done to it. But in this case, the <em>something</em> was the addition of an empty set to an existing set, so nothing at all.</p>
<p>One quick way to ensure that <code>places_visited</code> is actually being updated with something is to use the <code>assert_exists</code> function. This function will pass on the output if it exists, but give an error if the output is an empty set. Here is the same <code>update</code> with the incorrect name 'SLLLovakia', which will now give an error:</p>
<pre><code class="language-edgeql">update NPC
filter .name = 'Jonathan Harker'
set {
  places_visited += assert_exists((select Place filter .name = 'SLLovakia'))
};
</code></pre>
<p>Here is the output now:</p>
<pre><code>edgedb error: CardinalityViolationError: assert_exists violation:
expression returned an empty set
</code></pre>
<p>With that we now know {ref}<code>all three operators &lt;docs:ref_eql_statements_update&gt;</code> used after <code>set</code>: <code>:=</code>, <code>+=</code>, and <code>-=</code>.</p>
<p>Let's do another update. Remember the <code>lover</code> link on the <code>Person</code> type? Let's take a look at Jonathan and see how his love life is doing.</p>
<pre><code class="language-edgeql">select Person {
  name,
  lover
} filter .name = 'Jonathan Harker';
</code></pre>
<p>Here's the output:</p>
<pre><code>{default::NPC {name: 'Jonathan Harker', lover: {}}}
</code></pre>
<p>Ah, that's right. Mina Murray has Jonathan Harker as her <code>lover</code>, but Jonathan doesn't have her as his <code>lover</code> because we inserted him first before Mina Murray was inserted. We can change that now.</p>
<p>This command seems like it will work, but it doesn't quite. Do you remember why?</p>
<pre><code class="language-edgeql">update Person filter .name = 'Jonathan Harker'
set {
  lover := assert_single(
    (select Person filter .name = 'Mina Murray')
  )
};
</code></pre>
<p>No error is generated, but let's look at Jonathan Harker after the update:</p>
<pre><code class="language-edgeql">select Person { name, lover } filter .name = 'Jonathan Harker';
</code></pre>
<p>Surprisingly, the output is <code>{default::NPC {name: 'Jonathan Harker', lover: {}}}</code>!</p>
<p>After a bit of thought, we remember that we learned the <code>detached</code> keyword in Chapter 4 when inserting Mina. At the time we got the following error when we trie to insert Mina without using <code>detached</code>:</p>
<pre><code>error: QueryError: invalid reference to default::NPC: 
self-referencing INSERTs are not allowed
  ┌─ &lt;query&gt;:3:20
  │
3 │   lover := (select NPC filter .name = 'Jonathan Harker'),
  │                    ^^^ Use DETACHED if you meant to refer 
  to an uncorrelated default::NPC set
</code></pre>
<p>However, this time an error wasn't generated because we are doing an update, not an insert. Let's investigate exactly what happens here when <code>detached</code> doesn't get used.</p>
<p>First we'll do a quick <code>select</code> to see what's going on. We'll select Jonathan Harker and also add a computed <code>lover := (select Person filter .name = 'Mina Murray')</code> inside the shape to see what shows up:</p>
<pre><code class="language-edgeql">select Person {
 name,
 lover := (select Person filter .name = 'Mina Murray')
 } filter .name = 'Jonathan Harker';
</code></pre>
<p>Again, the output is <code>{default::NPC {name: 'Jonathan Harker', lover: {}}}</code>. That in itself is a hint that something didn't work properly. Let's try another <code>select</code>. This time we will simply make <code>lover</code> into a <code>(select Person {name})</code> to see everything that shows up before the filter. The query now looks like this:</p>
<pre><code class="language-edgeql">select Person {
 name,
 lover := (select Person {name})
 } filter .name = 'Jonathan Harker';
</code></pre>
<p>This time, the output is <em>very</em> interesting: <code>{default::NPC {name: 'Jonathan Harker', lover: default::NPC {name: 'Jonathan Harker'}}}</code>. This output proves that the <code>select Person</code> inside this query effectively means to select the <code>Person</code> object or objects that have already been selected! And we can't find the <code>Person</code> object called Mina if our set of <code>Person</code> objects only includes Jonathan Harker.</p>
<p>We can see the same behaviour if we remove the <code>filter</code>:</p>
<pre><code class="language-edgeql">select Person {
  name,
  lover_name := (select Person.name)
 };
</code></pre>
<p>There it is again: each time we use <code>select</code> without <code>detached</code> we are simply selecting the <code>Person</code> object in question, and not a full set of all the <code>Person</code> objects in the database.</p>
<pre><code>{
  default::MinorVampire {name: 'Vampire Woman 1', lover_name: 'Vampire Woman 1'},
  default::MinorVampire {name: 'Vampire Woman 2', lover_name: 'Vampire Woman 2'},
  default::MinorVampire {name: 'Vampire Woman 3', lover_name: 'Vampire Woman 3'},
  default::NPC {name: 'The innkeeper', lover_name: 'The innkeeper'},
  default::NPC {name: 'Mina Murray', lover_name: 'Mina Murray'},
  default::NPC {name: 'Jonathan Harker', lover_name: 'Jonathan Harker'},
  default::Vampire {name: 'Count Dracula', lover_name: 'Count Dracula'},
  default::PC {name: 'Emil Sinclair', lover_name: 'Emil Sinclair'},
}
</code></pre>
<p>So now let's do the update properly with the <code>detached</code> keyword so that Jonathan can finally be connected to Mina. (After all, he has enough to worry about without needing to think about this too.)</p>
<pre><code class="language-edgeql">update Person filter .name = 'Jonathan Harker'
set {
  lover := assert_single(
    (select detached Person filter .name = 'Mina Murray')
  )
};
</code></pre>
<p>And now <code>select</code> query now to make sure that it worked:</p>
<pre><code class="language-edgeql">select Person {
  name, 
  lover: {name}
  } filter .name = 'Jonathan Harker';
</code></pre>
<p>The output is now as follows:</p>
<pre><code>{default::NPC {name: 'Jonathan Harker', lover: default::NPC {name: 'Mina Murray'}}}
</code></pre>
<p>Success!</p>
<p>Now, if you use <code>update</code> without <code>filter</code> it will do the same change on all the types. This update below for example would give every <code>Person</code> type every single <code>Place</code> in the database under <code>places_visited</code>:</p>
<pre><code class="language-edgeql">update Person
set {
  places_visited := Place
};
</code></pre>
<h2 id="concatenation-with-"><a class="header" href="#concatenation-with-">Concatenation with ++</a></h2>
<p>One operator we haven't seen before is <code>++</code>, which does concatenation (joining together) instead of adding.</p>
<p>You can do simple operations with it like: <code>select 'My name is ' ++ 'Jonathan Harker';</code> which gives <code>{'My name is Jonathan Harker'}</code>. Or you can do more complicated concatenations as long as you continue to join strings to strings:</p>
<pre><code class="language-edgeql">select 'A character from the book: ' ++ (select NPC.name) 
       ++ ', who is not ' ++ (select Vampire.name);
</code></pre>
<p>This prints:</p>
<pre><code>{
  'A character from the book: The innkeeper, who is not Count Dracula',
  'A character from the book: Mina Murray, who is not Count Dracula',
  'A character from the book: Jonathan Harker, who is not Count Dracula',
}
</code></pre>
<p>The concatenation operator works on arrays too, putting them into a single array. So the output of:</p>
<pre><code class="language-edgeql">select ['I', 'am'] ++ ['Jonathan', 'Harker'];
</code></pre>
<p>Will be:</p>
<pre><code>{['I', 'am', 'Jonathan', 'Harker']}
</code></pre>
<p>The last type that the concatenation operator works on is <code>bytes</code>.</p>
<h2 id="using-insert-instead-of-select-when-adding-links"><a class="header" href="#using-insert-instead-of-select-when-adding-links">Using <code>insert</code> instead of <code>select</code> when adding links</a></h2>
<p>Let's also change the <code>Vampire</code> type to link it to <code>MinorVampire</code> from that side instead. You'll remember that Count Dracula is the only real vampire, while the others are of type <code>MinorVampire</code>. In the book, any person that Dracula bites becomes his slave. And once they die, they become another vampire that lives forever that Dracula can control with his mind (that's what makes the book scary). That means we need a <code>multi</code> link:</p>
<pre><code class="language-sdl">type Vampire extending Person {
  age: int16;
  multi slaves: MinorVampire;
}
</code></pre>
<p>Then we can <code>insert</code> the <code>MinorVampire</code> type at the same time as we insert the information for Count Dracula. But first let's remove the <code>master</code> link from <code>MinorVampire</code>, because it is a bit awkward to have objects linking to each other in this way. There are two reasons for that:</p>
<p>Extra work: A <code>MinorVampire</code> needs to have a <code>master</code> link, which means the order goes as follows:</p>
<ul>
<li>Insert the <code>Vampire</code> object Count Dracula.</li>
<li>Insert the <code>MinorVampire</code> objects that link to Count Dracula.</li>
<li>Count Dracula's <code>slaves</code> link is an empty set though, because nothing is linking him to the <code>MinorVampire</code> objects. Now we have to <code>update</code> him just to link back!</li>
</ul>
<p>Deletion: If both types link to each other, we won't be able to delete them if we need to. The error looks something like this:</p>
<pre><code>db&gt; delete MinorVampire;
  ERROR: ConstraintViolationError: deletion of default::MinorVampire
  (ee6ca100-006f-11ec-93a9-4b5d85e60114) is prohibited by link target policy
  Detail: Object is still referenced in link slave of default::Vampire
  (e5ef5bc6-006f-11ec-93a9-77e907d251d6).
db&gt; delete Vampire;
ERROR: ConstraintViolationError: deletion of default::Vampire
  (e5ef5bc6-006f-11ec-93a9-77e907d251d6) is prohibited by link target policy
  Detail: Object is still referenced in link master of default::MinorVampire (ee6ca100-006f-11ec-93a9-4b5d85e60114).
</code></pre>
<p>There are two options for working with this known as <em>backlinks</em> and <em>deletion policies</em>, which we will learn in chapters 14 and 18. With backlinks we can give <code>MinorVampire</code> a link based on what links <em>to</em> it, and with deletion policies we can change the rules on what can be deleted or not. But we aren't learning advanced concepts just yet so let's just keep things simple by just linking one way.</p>
<p>So first we simply change <code>MinorVampire</code> to a type extending <code>Person</code>:</p>
<pre><code class="language-sdl">type MinorVampire extending Person;
</code></pre>
<p>And then do a migration.</p>
<p>We said we would leave Dracula alone after all the practice deleting him before...but let's delete him again. Let's also delete the <code>MinorVampire</code> objects so that we can practise inserting them all at the same time.</p>
<p>So how do we link a <code>Vampire</code> object to a <code>MinorVampire</code> object if there are no <code>MinorVampire</code> objects to select? Quite easy: just <code>insert</code> them and keep their inserts inside a set with <code>{}</code>. Remember: using <code>select</code> will return a set of objects, but <code>insert</code> returns one or more objects too. So if we capture the output of <code>insert</code>, we can just declare these objects as the objects to link to.</p>
<p>Here's what the insert looks like:</p>
<pre><code class="language-edgeql">insert Vampire {
  name := 'Count Dracula',
  age := 800,
  slaves := {
    (insert MinorVampire {
      name := 'Vampire Woman 1',
    }),
    (insert MinorVampire {
      name := 'Vampire Woman 2',
    }),
    (insert MinorVampire {
      name := 'Vampire Woman 3',
    }),
  }
};
</code></pre>
<p>Now we don't have to insert the <code>MinorVampire</code> types first and then filter: we can just put them in together with Dracula.</p>
<p>Then when we <code>select Vampire</code> like this:</p>
<pre><code class="language-edgeql">select Vampire {
  name,
  slaves: {name}
};
</code></pre>
<p>We have a nice output that shows them all together:</p>
<pre><code>{
  default::Vampire {
    name: 'Count Dracula',
    slaves: {
      default::MinorVampire {name: 'Vampire Woman 1'},
      default::MinorVampire {name: 'Vampire Woman 2'},
      default::MinorVampire {name: 'Vampire Woman 3'},
    },
  },
}
</code></pre>
<p>Speaking of output, EdgeDB lets you display your output in a number of different ways. One of them is JSON!</p>
<h2 id="just-type-json-to-generate-json"><a class="header" href="#just-type-json-to-generate-json">Just type &lt;json&gt; to generate json</a></h2>
<p>What do we do if we want to see output in JSON? It couldn't be easier: just cast using <code>&lt;json&gt;</code>. Any type in EdgeDB can be cast to JSON this easily:</p>
<pre><code class="language-edgeql"># &lt;json&gt; is the only difference from the select above
select &lt;json&gt;Vampire {
  name,
  slaves: {name}
};
</code></pre>
<p>This will transform the results into JSON. However, what the REPL will show by default looks more like this:</p>
<pre><code>{
  Json(&quot;{\&quot;name\&quot;: \&quot;Count Dracula\&quot;, \&quot;slaves\&quot;: [{\&quot;name\&quot;: \&quot;Vampire Woman 1\&quot;}, {\&quot;name\&quot;: \&quot;Vampire Woman 2\&quot;}, {\&quot;name\&quot;: \&quot;Vampire Woman 3\&quot;}]}&quot;),
}
</code></pre>
<p>Let's go through the result together. The outer curly braces are just telling you that what's inside is one or more results returned by the query. Then the actual result is a string containing JSON. Because the JSON part is inside a string all the <code>&quot;</code> there need to be escaped, so they appear as <code>\&quot;</code>.</p>
<p>That's a great JSON output for computers to handle, but it's a little bit ugly for us. Fortunately we can change this: to make the REPL show JSON in a nicer format just type <code>\set output-format json-pretty</code>. Then the results will look more familiar:</p>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;Count Dracula&quot;,
  &quot;slaves&quot;: [{&quot;name&quot;: &quot;Vampire Woman 1&quot;}, {&quot;name&quot;: &quot;Vampire Woman 2&quot;}, {&quot;name&quot;: &quot;Vampire Woman 3&quot;}]
}
</code></pre>
<p>Now to get back to the default format, we can type <code>\set output-format default</code>.
To keep things easy to read, this book will show JSON output using this <code>json-pretty</code> output format.</p>
<h2 id="converting-back-from-json"><a class="header" href="#converting-back-from-json">Converting back from JSON</a></h2>
<p>So what about the other way around, namely JSON to an EdgeDB type? You can do this too, but remember to think about the JSON type that you are giving to cast. The EdgeDB philosophy is that casts should be symmetrical: a type cast into JSON should only be cast back into that type. For example, here is the first date in the book Dracula as a string, then cast to JSON and then into a <code>cal::local_date</code>:</p>
<pre><code class="language-edgeql">select &lt;cal::local_date&gt;&lt;json&gt;'18930503';
</code></pre>
<p>This is fine because <code>&lt;json&gt;</code> turns it into a JSON string, and <code>cal::local_date</code> can be created from a string. The result we get is <code>{&lt;cal::local_date&gt;'1893-05-03'}</code>. But if we try to turn the JSON value into an <code>int64</code>, it won't work:</p>
<pre><code class="language-edgeql">select &lt;int64&gt;&lt;json&gt;'18930503';
</code></pre>
<p>The problem is that it is a conversion from a JSON string to an EdgeDB <code>int64</code>. It gives this error: <code>edgedb error: InvalidValueError: expected JSON number or null; got JSON string</code>. To keep things symmetrical, you need to cast a JSON string to an EdgeDB <code>str</code> and then cast into an <code>int64</code>:</p>
<pre><code class="language-edgeql">select &lt;int64&gt;&lt;str&gt;&lt;json&gt;'18930503';
</code></pre>
<p>Now it works: we get <code>{18930503}</code> which began as an EdgeDB <code>str</code>, turned into a JSON string, then back into an EdgeDB <code>str</code>, and finally was cast into an <code>int64</code>.</p>
<p>The {ref}<code>documentation on JSON &lt;docs:ref_std_json&gt;</code> explains which JSON types turn into which EdgeDB types, lists functions for working with JSON values, and is good to bookmark if you need to convert from JSON a lot. Here is a simplified explanation from the documentation:</p>
<ul>
<li>JSON strings can be cast to a <code>str</code>. Casting uuid and date/time types to JSON returns a JSON string. You can cast back into those types, as long as the formatting is correct.</li>
<li>JSON numbers can be cast to any numeric type.</li>
<li>JSON booleans can be cast to a bool type.</li>
<li>JSON null is unique because it can be cast to an empty set ({}) of any type.</li>
<li>JSON arrays can be cast to any valid array type, but its items must be all the same time, the array cannot contain null, and it can't contain another array.</li>
</ul>
<p>One quick way to turn JSON into a more usable form is to use the <code>json_object_unpack()</code> function, which returns a set of <code>tuple&lt;str, json&gt;</code>.</p>
<p>We will learn a lot more about tuples in Chapter 10, but for now just remember that they use <code>()`` parentheses, can contain different types, and that you access their items by using a dot. So this query will return </code>{10}`:</p>
<pre><code class="language-edgeql">select ('Jonathan Harker', 10).1;
</code></pre>
<p>Now let's look at the <code>json_object_unpack()</code> function with a simple query:</p>
<pre><code class="language-edgeql">with json_dracula := &lt;json&gt;(select Vampire {*}),
  select json_object_unpack(json_dracula);
</code></pre>
<p>The output will look as follows:</p>
<pre><code>{
  ('id', Json(&quot;\&quot;3bc8e902-19d9-11ee-92bf-b3c5cf277bc7\&quot;&quot;)),
  ('age', Json(&quot;800&quot;)),
  ('name', Json(&quot;\&quot;Count Dracula\&quot;&quot;)),
  ('is_single', Json(&quot;true&quot;)),
}
</code></pre>
<p>Change the splat operator from <code>*</code> to <code>**</code> and it gets even more verbose!</p>
<pre><code>{
  ('id', Json(&quot;\&quot;3bc8e902-19d9-11ee-92bf-b3c5cf277bc7\&quot;&quot;)),
  ('age', Json(&quot;800&quot;)),
  ('name', Json(&quot;\&quot;Count Dracula\&quot;&quot;)),
  ('lover', Json(&quot;null&quot;)),
  (
    'slaves',
    Json(&quot;[
      {\&quot;id\&quot;: \&quot;3bc8f1b8-19d9-11ee-92bf-1bd2fcb94b84\&quot;, \&quot;name\&quot;: \&quot;Vampire Woman 1\&quot;, \&quot;is_single\&quot;: true}, 
      {\&quot;id\&quot;: \&quot;3bc8fc08-19d9-11ee-92bf-0f167ba34818\&quot;, \&quot;name\&quot;: \&quot;Vampire Woman 2\&quot;, \&quot;is_single\&quot;: true}, 
      {\&quot;id\&quot;: \&quot;3bc8fcee-19d9-11ee-92bf-cfa75bcb2757\&quot;, \&quot;name\&quot;: \&quot;Vampire Woman 3\&quot;, \&quot;is_single\&quot;: true}]&quot;),
  ),
  ('is_single', Json(&quot;true&quot;)),
  ('places_visited', Json(&quot;[]&quot;)),
}
</code></pre>
<p>There are quite a few other functions related to JSON in the documentation, so do take a look if you need to work with JSON in some other way. Some of the functions include <code>json_array_unpack()</code>, <code>json_get()</code>, <code>json_set()</code>, <code>json_typeof()</code>, and <code>json_object_pack()</code>.</p>
<p><a href="code.html">Here is all our code so far up to Chapter 6.</a></p>
<!-- quiz-start -->
<h2 id="time-to-practice"><a class="header" href="#time-to-practice">Time to practice</a></h2>
<ol>
<li>
<p>This select is incomplete. How would you complete it so that it says &quot;Pleased to meet you. I'm &quot; and then the NPC's name followed by a period?</p>
<pre><code class="language-edgeql">select NPC {
  name,
  greeting := ## Put the rest here
};
</code></pre>
</li>
<li>
<p>How would you update Mina's <code>places_visited</code> to include Romania if she went to Castle Dracula for a visit?</p>
</li>
<li>
<p>With the set <code>{'W', 'J', 'C'}</code>, how would you display all the <code>Person</code> types with a name that contains any of these capital letters?</p>
<p>Hint: it involves <code>with</code> and a bit of concatenation.</p>
</li>
<li>
<p>How would you display this same query as JSON?</p>
</li>
<li>
<p>How would you add ' the Great' to every Person type?</p>
<p>Bonus question: what's a quick way to undo this using string indexing?</p>
</li>
</ol>
<p><a href="answers.html">See the answers here.</a></p>
<!-- quiz-end -->
<p><strong>Up next:</strong> <em>Jonathan climbs the castle wall to get into the Count's room.</em></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../chapter5/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../chapter7/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../chapter5/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../chapter7/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
