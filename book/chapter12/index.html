<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Chapter 12 - From bad to worse</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../chapter1/index.html"><strong aria-hidden="true">1.</strong> Chapter 1 - Jonathan Harker travels to Transylvania</a></li><li class="chapter-item expanded "><a href="../chapter2/index.html"><strong aria-hidden="true">2.</strong> Chapter 2 - At the Hotel in Bistritz</a></li><li class="chapter-item expanded "><a href="../chapter3/index.html"><strong aria-hidden="true">3.</strong> Chapter 3 - Jonathan goes to Castle Dracula</a></li><li class="chapter-item expanded "><a href="../chapter4/index.html"><strong aria-hidden="true">4.</strong> Chapter 4 - "What a strange man this Count Dracula is."</a></li><li class="chapter-item expanded "><a href="../chapter5/index.html"><strong aria-hidden="true">5.</strong> Chapter 5 - Jonathan tries to leave the castle</a></li><li class="chapter-item expanded "><a href="../chapter6/index.html"><strong aria-hidden="true">6.</strong> Chapter 6 - Still no escape</a></li><li class="chapter-item expanded "><a href="../chapter7/index.html"><strong aria-hidden="true">7.</strong> Chapter 7 - Jonathan finally "leaves" the castle</a></li><li class="chapter-item expanded "><a href="../chapter8/index.html"><strong aria-hidden="true">8.</strong> Chapter 8 - Dracula takes the boat to England</a></li><li class="chapter-item expanded "><a href="../chapter9/index.html"><strong aria-hidden="true">9.</strong> Chapter 9 - Strange events in England</a></li><li class="chapter-item expanded "><a href="../chapter10/index.html"><strong aria-hidden="true">10.</strong> Chapter 10 - Terrible events in Whitby</a></li><li class="chapter-item expanded "><a href="../chapter11/index.html"><strong aria-hidden="true">11.</strong> Chapter 11 - What's wrong with Lucy?</a></li><li class="chapter-item expanded "><a href="../chapter12/index.html" class="active"><strong aria-hidden="true">12.</strong> Chapter 12 - From bad to worse</a></li><li class="chapter-item expanded "><a href="../chapter13/index.html"><strong aria-hidden="true">13.</strong> Chapter 13 - Farewell, Lucy. Meet the new Lucy</a></li><li class="chapter-item expanded "><a href="../chapter14/index.html"><strong aria-hidden="true">14.</strong> Chapter 14 - Jonathan Harker returns</a></li><li class="chapter-item expanded "><a href="../chapter15/index.html"><strong aria-hidden="true">15.</strong> Chapter 15 - Time to start vampire hunting</a></li><li class="chapter-item expanded "><a href="../chapter16/index.html"><strong aria-hidden="true">16.</strong> Chapter 16 - Is Renfield telling the truth?</a></li><li class="chapter-item expanded "><a href="../chapter17/index.html"><strong aria-hidden="true">17.</strong> Chapter 17 - Poor Renfield. Poor Mina.</a></li><li class="chapter-item expanded "><a href="../chapter18/index.html"><strong aria-hidden="true">18.</strong> Chapter 18 - Using Dracula's own weapon against him</a></li><li class="chapter-item expanded "><a href="../chapter19/index.html"><strong aria-hidden="true">19.</strong> Chapter 19 - Dracula escapes</a></li><li class="chapter-item expanded "><a href="../chapter20/index.html"><strong aria-hidden="true">20.</strong> Chapter 20 - The final battle</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <hr />
<h2 id="tags-overloading-functions-coalescing"><a class="header" href="#tags-overloading-functions-coalescing">tags: Overloading Functions, Coalescing</a></h2>
<h1 id="chapter-12---from-bad-to-worse"><a class="header" href="#chapter-12---from-bad-to-worse">Chapter 12 - From bad to worse</a></h1>
<p>There is no good news for our heroes this chapter:</p>
<blockquote>
<p>Dracula continues to break into Lucy's room every time people don't listen to Van Helsing's advice, and every time the men give their blood to save her. Dracula always turns into a cloud to sneak in, drinks her blood and sneaks away before morning. Lucy is getting so weak that it's a surprise that she's still alive.</p>
<p>Meanwhile, Renfield breaks out of his cell and attacks Dr. Seward with a knife, causing him to bleed. The moment Renfield sees Dr. Seward's blood he stops and tries to drink it, repeating: “The blood is the life! The blood is the life!”. The asylum security men take Renfield away and Dr. Seward is left confused and trying to understand him. Dr. Seward thinks there is a connection between him and the other events.</p>
<p>That night, a wolf controlled by Dracula breaks the windows of Lucy's room and Dracula is able to get in again...</p>
</blockquote>
<p>But there is good news for us, because we are going to keep learning about Cartesian products, plus how to overload a function.</p>
<h2 id="overloading-functions"><a class="header" href="#overloading-functions">Overloading functions</a></h2>
<p>Functions can be overloaded in EdgeDB. Overloading a function means to create a function with the same name as another function but with a different signature, thereby allowing it to take in and return different types. The <code>cal::to_local_date()</code> function that we saw in Chapter 9 is an example of an overloaded function as there are three ways to use it:</p>
<pre><code>cal::to_local_date(s: str, fmt: optional str = {}) -&gt; local_date
cal::to_local_date(dt: datetime, zone: str) -&gt; local_date
cal::to_local_date(year: int64, month: int64, day: int64) -&gt; local_date
</code></pre>
<p>Last chapter, we gave every character a strength of 5 and used the <code>fight()</code> function for a few of them. That's why the Innkeeper defeated Dracula, which is obviously not what would really happen. We should give Dracula a more realistic strength, and randomize some of the strength values for some of our characters.</p>
<p>Jonathan Harker is just a human but is still quite strong. We'll let him keep his strength of 5. We'll treat that as the maximum strength for a human, except Renfield who is a bit unique - we gave him a strength of 10 when we inserted him. And we'll make sure Count Dracula gets 20 strength, because he's Dracula. So we only have to update Count Dracula's strength:</p>
<pre><code class="language-edgeql">update Vampire
filter .name = 'Count Dracula'
set {
  strength := 20
};
</code></pre>
<p>Every other human should have a strength between 0 and 5. EdgeDB has a function called {eql:func}<code>docs:std::random</code> that gives a <code>float64</code> in between 0.0 and 1.0. If we multiply this by 5, we will get a <code>float64</code> in between 0.0 and 5.0. There is another function called {eql:func}<code>docs:std::round</code> that rounds numbers, so we'll use that too, and finally cast it to an <code>&lt;int16&gt;</code>. Give this a try a few times to see the <code>random()</code> function in action:</p>
<pre><code class="language-edgeql">with before_rounded := random() * 5,
  after_rounded := round(before_rounded),
  select (before_rounded, after_rounded);
</code></pre>
<p>The number will differ every time, but the output will look something like <code>{(3.9557656033819555, 4)}</code>. After that we'll just need to cast the rounded number into an <code>int16</code> and that will work as a random <code>strength</code> value for each of our <code>Person</code> objects (except for Jonathan, Dracula and Renfield). Here is what the update looks like:</p>
<pre><code class="language-edgeql">update Person
  filter .name not in {'Jonathan Harker', 'Count Dracula', 'Renfield'}
  set {
    strength := &lt;int16&gt;round(random() * 5)
  };
</code></pre>
<p>The vampire women are also pretty strong. Let's give them a random strength plus 5. This will ensure that they are stronger than average humans but not as strong as Dracula:</p>
<pre><code class="language-edgeql">update MinorVampire
  set {
    strength := &lt;int16&gt;round(random() * 5) + 5
  };
</code></pre>
<p>Now let's <code>select Person { name, strength };</code> and see if it works. The output should have mostly random numbers now, something similar to this:</p>
<pre><code>{
  default::Crewman {name: 'Crewman 1', strength: 1},
  default::Crewman {name: 'Crewman 2', strength: 4},
  default::Crewman {name: 'Crewman 3', strength: 3},
  default::Crewman {name: 'Crewman 4', strength: 2},
  default::Crewman {name: 'Crewman 5', strength: 3},
  default::MinorVampire {name: 'Vampire Woman 1', strength: 1},
  default::MinorVampire {name: 'Vampire Woman 2', strength: 4},
  default::MinorVampire {name: 'Vampire Woman 3', strength: 3},
  default::Sailor {name: 'The Captain', strength: 0},
  default::Sailor {name: 'Petrofsky', strength: 3},
  default::Sailor {name: 'The First Mate', strength: 4},
  default::Sailor {name: 'The Cook', strength: 1},
  default::PC {name: 'Emil Sinclair', strength: 5},
  default::PC {name: 'Max Demian', strength: 3},
  default::NPC {name: 'Renfield', strength: 10},
  default::NPC {name: 'Jonathan Harker', strength: 5},
  default::NPC {name: 'The innkeeper', strength: 2},
  default::NPC {name: 'Mina Murray', strength: 2},
  default::NPC {name: 'Quincey Morris', strength: 3},
  default::NPC {name: 'Arthur Holmwood', strength: 2},
  default::NPC {name: 'John Seward', strength: 1},
  default::NPC {name: 'Abraham Van Helsing', strength: 1},
  default::NPC {name: 'Lucy Westenra', strength: 3},
  default::Vampire {name: 'Count Dracula', strength: 20},
}
</code></pre>
<p>Looks like it worked.</p>
<p>So now let's overload the <code>fight()</code> function. Right now it only works for one <code>Person</code> vs. another <code>Person</code>, but in the book all the characters get together to try to defeat Dracula. We'll need to overload the function so that more than one character can work together to fight.</p>
<pre><code class="language-sdl">function fight(people_names: array&lt;str&gt;, opponent: Person) -&gt; str
  using (
    with
        people := (select Person filter contains(people_names, .name)),
    select
        array_join(people_names, ', ') ++ ' win!'
        if sum(people.strength) &gt; (opponent.strength ?? 0)
        else opponent.name ++ ' wins!'
  );
</code></pre>
<p>With this overloaded function we accept two arguments: an array of the names of the fighters and a <code>Person</code> object that is their opponent. You're seeing a couple of new standard library functions in use here that we'll dig into more later. For now, here are the basics you need to know:</p>
<ul>
<li>We call <code>contains</code>, passing our array of names and the <code>.name</code> property. This allows us to filter only <code>Person</code> objects with a <code>.name</code> that matches one of those in the array.</li>
<li><code>sum</code> in the next line of our <code>select</code> takes all the values in a set and adds them together. That gives us a total strength of the fighters to compare against their opponent's strength.</li>
</ul>
<p>Note that overloading only works if the function signature is different. Here are the two signatures we have now for comparison:</p>
<pre><code class="language-sdl">fight(one: Person, two: Person) -&gt; str
fight(people_names: array&lt;str&gt;, opponent: Person) -&gt; str
</code></pre>
<p>If we tried to overload our function with an input of <code>(Person, Person)</code>, it wouldn't work because that's the same as the original signature. EdgeDB uses the input we give it to decide which form of the function to use, so without different signatures, it would have no way to decide between the two.</p>
<p>The function name is the same, but to call it, we enter an array of the fighters' names and the <code>Person</code> they are fighting.</p>
<p>Let's do a migration now and see what happens if Jonathan and Renfield try to fight Dracula together. The migration output is a little interesting, as EdgeDB simply asks us if we created a function <code>default::fight</code> - it doesn't ask us if we overloaded a function. For humans the function looks the same because of the function name (which is what makes overloading convenient), but as far as EdgeDB is concerned this simply an entirely new function.</p>
<pre><code>c:\easy-edgedb&gt;edgedb migration create
Connecting to an EdgeDB instance at localhost:10716...
did you create function 'default::fight'? [y,n,l,c,b,s,q,?]
&gt; y
</code></pre>
<p>Now it's time to join together to fight Dracula. Good luck!</p>
<pre><code class="language-edgeql">with
  party := ['Jonathan Harker', 'Renfield'],
  dracula := (select Person filter .name = 'Count Dracula'),
select fight(party, dracula);
</code></pre>
<p>So did they...</p>
<pre><code>{'Count Dracula wins!'}
</code></pre>
<p>No, they didn't win. How about five people?</p>
<pre><code class="language-edgeql">with
  party := ['Jonathan Harker', 'Renfield', 'Arthur Holmwood', 
    'The innkeeper', 'Lucy Westenra'],
  dracula := (select Person filter .name = 'Count Dracula'),
select fight(party , dracula);
</code></pre>
<p>At this point it is most likely that the random <code>strength</code> values for everyone together will be greater than 20 and they will finally win. Then we will see the following output:</p>
<pre><code>{'Jonathan Harker, Renfield, Arthur Holmwood, The innkeeper, Lucy Westenra win!'}
</code></pre>
<p>So that's how function overloading works - you can create functions with the same name as long as the signature is different.</p>
<p><code>fight()</code> was pretty fun to make, but that sort of function is better done on the gaming side. So let's make a function that we might actually use. Since EdgeQL is a query language, the most useful functions are usually ones that make queries shorter.</p>
<p>Here is a simple one that tells us if a <code>Person</code> type has visited a <code>Place</code> or not:</p>
<pre><code class="language-sdl">function visited(person: str, city: str) -&gt; bool
  using (
    with person := (select Person filter .name = person),
    select city in person.places_visited.name
  );
</code></pre>
<p>Pretty simple! Let's add it to the schema and do a migration. Now our queries are much shorter:</p>
<pre><code>db&gt; select visited('Mina Murray', 'London');
{true}
db&gt; select visited('Mina Murray', 'Bistritz');
{false}
</code></pre>
<p>Thanks to the function, even more complicated queries are still quite readable:</p>
<pre><code class="language-edgeql">select (
  'Did Mina visit Bistritz? ' ++ &lt;str&gt;visited('Mina Murray', 'Bistritz'),
  'What about Jonathan and Romania? ' 
    ++ &lt;str&gt;visited('Jonathan Harker', 'Romania')
);
</code></pre>
<p>This prints <code>{('Did Mina visit Bistritz? false', 'What about Jonathan and Romania? true')}</code>.</p>
<h2 id="more-about-cartesian-products-and-the-coalescing-operator"><a class="header" href="#more-about-cartesian-products-and-the-coalescing-operator">More about Cartesian products and the coalescing operator</a></h2>
<p>Now let's learn more about Cartesian products in EdgeDB. You might recall from the previous chapter that even a single empty set always results in an output of <code>{}</code> when working with multiple sets:</p>
<pre><code>edgedb&gt; select 'My name is ' ++ &lt;str&gt;{} ++ '!';
{}
</code></pre>
<p>That's why we had to change our <code>fight()</code> function to use the coalescing operator in the previous chapter. Let's dig a little deeper into why that is.</p>
<p>Remember, a <code>{}</code> has a length of 0 and anything multiplied by 0 is also 0. For example, let's try to concatenate the names of places that start with b with those that start with x.</p>
<pre><code class="language-edgeql">with b_places := (select Place filter Place.name ilike 'b%'),
     x_places := (select Place filter Place.name ilike 'x%'),
select b_places.name ++ ' ' ++ x_places.name;
</code></pre>
<p>Yep, it's an empty set.</p>
<pre><code>{}
</code></pre>
<p>Let's explore this a bit more. A search for places that start with &quot;b&quot; should give us <code>{'Buda-Pesth', 'Bistritz'}</code>. Let's manually type out the city names this time just to make sure and add an empty set after:</p>
<pre><code class="language-edgeql">select {'Buda-Pesth', 'Bistritz'} ++ {};
</code></pre>
<p>So that should give a <code>{}</code>. The output is...</p>
<pre><code>error: operator '++' cannot be applied to operands of type 'std::str' and 'anytype'
  ┌─ query:1:8
  │
1 │ select {'Buda-Pesth', 'Bistritz'} ++ {};
  │        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Consider 
using an explicit type cast or a conversion function.
</code></pre>
<p>Ah, that's right - we saw one example of an empty set with a cast in the last chapter when we tried the query <code>select &lt;str&gt;{} ?? 'Count Dracula is now in Whitby';</code>. EdgeDB requires a cast for an empty set, because there's no way to know the type of a set if all EdgeDB sees is <code>{}</code>.</p>
<p>You can probably guess that the same is true for array or set constructors too, so <code>select [];</code> returns an error: <code>QueryError: expression returns value of indeterminate type</code>. And <code>select {};</code> too.</p>
<p>Okay, one more time, this time making sure that the <code>{}</code> empty set is of type <code>str</code>:</p>
<pre><code>db&gt; select {'Buda-Pesth', 'Bistritz'} ++ &lt;str&gt;{};
{}
</code></pre>
<p>Good, so we have manually confirmed that using <code>{}</code> with another set always returns <code>{}</code>. But we would like to do the following:</p>
<ul>
<li>Concatenate the two strings if they exist, and</li>
<li>Return what we have if one is an empty set.</li>
</ul>
<p>In other words, we would like to add <code>{'Buda-Peth', 'Bistritz'}</code> to another set and return the original <code>{'Buda-Peth', 'Bistritz'}</code> if the second is empty. So we use the {eql:op}<code>coalescing operator &lt;docs:coalesce&gt;</code> to make it work:</p>
<pre><code class="language-edgeql">with b_places := (select Place filter .name ilike 'b%'),
     x_places := (select Place filter .name ilike 'x%'),
select b_places.name ++ ' ' ++ x_places.name
  if exists b_places.name and exists x_places.name
  else b_places.name ?? x_places.name;
</code></pre>
<p>This returns:</p>
<pre><code>{'Buda-Pesth', 'Bistritz'}
</code></pre>
<p>That's better.</p>
<p>But now back to Cartesian products. Remember, when we add or concatenate sets we are working with <em>every item in each set</em> separately. Let's see what happens if we change the query to search for places that start with b (Buda-Pesth and Bistritz) and m (Munich). We would like to get the result <code>{'Buda-Pesth, Bistritz, Munich'}</code>, but it doesn't quite work that way:</p>
<pre><code class="language-edgeql">with b_places := (select Place filter .name ilike 'b%'),
     m_places := (select Place filter .name ilike 'm%'),
select b_places.name ++ ' ' ++ m_places.name
  if exists b_places.name and exists m_places.name
  else b_places.name ?? m_places.name;
</code></pre>
<p>We get this result instead:</p>
<pre><code>{'Buda-Pesth Munich', 'Bistritz Munich'}
</code></pre>
<p>In other words, we concatenated each item inside each set with each item inside the other. How can we just join one set with another one instead?</p>
<p>One way to join the two together without thinking about Cartesian multiplication is to turn them into an array. The {eql:func}<code>docs:std::array_agg</code> function will do this: it 'aggregates' them.</p>
<pre><code class="language-edgeql">with b_places := (select Place filter .name ilike 'b%'),
     m_places := (select Place filter .name ilike 'm%'),
select array_agg(b_places.name) ++
       array_agg(m_places.name);
</code></pre>
<p>Using this gives us an output of <code>{['Buda-Pesth', 'Bistritz', 'Munich']}</code>.</p>
<p>But if we just want to stick with a set, there is an even easier way: just <code>union</code> the sets.</p>
<pre><code class="language-edgeql">with b_places := (select Place filter .name ilike 'b%'),
     m_places := (select Place filter .name ilike 'm%'),
  select b_places.name union m_places.name;
</code></pre>
<p>And that will give us an output of <code>{'Buda-Pesth', 'Bistritz', 'Munich'}</code>.</p>
<p>With this, we don't need to worry about getting <code>{}</code> if we choose a letter like x. Let's look at every place that contains k or e:</p>
<pre><code class="language-edgeql">with has_k := (select Place filter .name ilike '%k%'),
     has_e := (select Place filter .name ilike '%e%'),
     has_either := has_k union has_e,
select has_either.name;
</code></pre>
<p>This gives us the result:</p>
<pre><code>{'Slovakia', 'France', 'Castle Dracula', 'Buda-Pesth'}
</code></pre>
<p>Similarly, you can use <code>?=</code> instead of <code>=</code> and <code>?!=</code> instead of <code>!=</code> when doing comparisons if you think one side might be an empty set. So if you can write a query like this:</p>
<pre><code class="language-edgeql">with city_names := {'Slovakia', 'Buda-Pesth', 'Castle Dracula'},
     city_name := (select City.name filter City.name = &quot;Hi I'm a City&quot;),
select city_names = city_name;
</code></pre>
<p>It will return <code>{}</code> because <code>city_name</code> has returned an empty set. Now if we change <code>=</code> to <code>?=</code> then the query will work as we would like:</p>
<pre><code class="language-edgeql">with city_names := {'Slovakia', 'Buda-Pesth', 'Castle Dracula'},
     city_name := (select City.name filter City.name = &quot;Hi I'm a City&quot;),
select city_names ?= city_name;
</code></pre>
<p>This will return the output <code>{false, false, false}</code> instead of <code>{}</code> for the whole thing. </p>
<p>In addition, two empty sets are treated as equal if you use <code>?=</code>. So this query will return <code>{true}</code>:</p>
<pre><code class="language-edgeql">select Vampire.lovers.name ?= Crewman.lovers.name;
</code></pre>
<p>It returns <code>{true}</code> because neither Dracula nor any of the Crewmen have a lover: both sides of the query return empty sets of type <code>str</code>. If we had used <code>=</code> instead of <code>?=</code> in this case, we would have just seen an empty set.</p>
<p><a href="code.html">Here is all our code so far up to Chapter 12.</a></p>
<!-- quiz-start -->
<h2 id="time-to-practice"><a class="header" href="#time-to-practice">Time to practice</a></h2>
<ol>
<li>
<p>Consider these two functions. Will EdgeDB allow both of them to be defined at the same time?</p>
<p>First function:</p>
<pre><code class="language-sdl">function gives_number(input: int64) -&gt; int64
  using(input);
</code></pre>
<p>Second function:</p>
<pre><code class="language-sdl">function gives_number(input: int64) -&gt; int32
  using(&lt;int32&gt;input);
</code></pre>
</li>
<li>
<p>How about these two functions? Will EdgeDB allow both of them to be defined at the same time?</p>
<p>First function:</p>
<pre><code class="language-sdl">function make64(input: int16) -&gt; int64
  using(input);
</code></pre>
<p>Second function:</p>
<pre><code class="language-sdl">function make64(input: int32) -&gt; int64
  using(input);
</code></pre>
</li>
<li>
<p>Will <code>select {} ?? {3, 4} ?? {5, 6};</code> work?</p>
</li>
<li>
<p>Will <code>select &lt;int64&gt;{} ?? &lt;int64&gt;{} ?? {1, 2};</code> work?</p>
</li>
<li>
<p>Trying to make a single string of everyone's name with <code>select array_join(array_agg(Person.name));</code> isn't working. What's the problem?</p>
</li>
</ol>
<p><a href="answers.html">See the answers here.</a></p>
<!-- quiz-end -->
<p><strong>Up next:</strong> <em>One of the men gives his blood to try to save Lucy. Will it be enough?</em></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../chapter11/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../chapter13/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../chapter11/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../chapter13/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
